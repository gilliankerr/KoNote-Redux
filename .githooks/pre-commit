#!/bin/sh
# =============================================================================
# Git pre-commit hook: Ensure .po and .mo files stay in sync
# =============================================================================
#
# If a .po (translation source) file is staged for commit but the matching
# .mo (compiled translation) file is NOT staged, the commit is blocked with
# a clear message explaining how to fix it.
#
# This prevents a common mistake: editing translations but forgetting to
# recompile them, which means the running app still shows old translations.
#
# Setup (run once per clone):
#   git config core.hooksPath .githooks
#
# To bypass this hook in an emergency:
#   git commit --no-verify
# =============================================================================

# Get list of staged .po files (Added, Modified, or Copied)
STAGED_PO=$(git diff --cached --name-only --diff-filter=ACM | grep '\.po$' || true)

if [ -z "$STAGED_PO" ]; then
    # No .po files staged -- nothing to check
    exit 0
fi

ERRORS=""

for po_file in $STAGED_PO; do
    # Derive the expected .mo path by replacing .po with .mo
    mo_file="${po_file%.po}.mo"

    # Check if the .mo file is also staged
    MO_STAGED=$(git diff --cached --name-only | grep "^${mo_file}$" || true)

    if [ -z "$MO_STAGED" ]; then
        if [ ! -f "$mo_file" ]; then
            # .mo file doesn't exist at all
            ERRORS="${ERRORS}\n  - ${po_file} is staged but ${mo_file} does NOT exist"
        else
            # .mo exists but isn't staged — check if it actually changed.
            # When new .po entries have empty translations, the compiled .mo
            # output is identical (empty msgstr entries are omitted from .mo).
            # In that case the .mo is up-to-date and doesn't need staging.
            MO_TREE_HASH=$(git hash-object "$mo_file" 2>/dev/null || echo "none")
            MO_HEAD_HASH=$(git rev-parse "HEAD:${mo_file}" 2>/dev/null || echo "missing")
            if [ "$MO_TREE_HASH" != "$MO_HEAD_HASH" ]; then
                ERRORS="${ERRORS}\n  - ${po_file} is staged but ${mo_file} is NOT staged"
            fi
        fi
    fi
done

if [ -n "$ERRORS" ]; then
    echo ""
    echo "======================================================="
    echo "  COMMIT BLOCKED: Translation files out of sync"
    echo "======================================================="
    echo ""
    echo "  Translation source (.po) changed but the compiled"
    echo "  file (.mo) is not updated or not staged."
    echo ""
    echo "  Problems found:"
    printf "$ERRORS\n"
    echo ""
    echo "  How to fix:"
    echo "  1. Compile:  python manage.py compilemessages"
    echo "     (or if gettext is not installed locally:)"
    echo "     python scripts/validate_translations.py"
    echo "     msgfmt locale/fr/LC_MESSAGES/django.po -o locale/fr/LC_MESSAGES/django.mo"
    echo ""
    echo "  2. Stage:    git add locale/*/LC_MESSAGES/django.mo"
    echo ""
    echo "  3. Commit again."
    echo ""
    echo "  To skip this check (emergency only):"
    echo "     git commit --no-verify"
    echo ""
    echo "======================================================="
    exit 1
fi

# =============================================================================
# Advisory check: warn if .html templates changed but .po wasn't updated
# This is a WARNING only — it does NOT block the commit.
# =============================================================================

STAGED_HTML=$(git diff --cached --name-only --diff-filter=ACM | grep '\.html$' || true)

if [ -n "$STAGED_HTML" ]; then
    # Check if any .po file was also staged
    PO_ALSO_STAGED=$(git diff --cached --name-only | grep '\.po$' || true)

    if [ -z "$PO_ALSO_STAGED" ]; then
        echo ""
        echo "-------------------------------------------------------"
        echo "  NOTE: Template files changed but .po was not updated"
        echo "-------------------------------------------------------"
        echo ""
        echo "  If you added or changed {% trans %} or {% blocktrans %}"
        echo "  tags, French translations may be incomplete."
        echo ""
        echo "  Run: python manage.py translate_strings"
        echo ""
        echo "  (This is a reminder, not a blocker — commit proceeds.)"
        echo "-------------------------------------------------------"
        echo ""
    fi
fi

exit 0
