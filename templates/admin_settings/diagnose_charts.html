{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Chart Diagnostics" %} â€” {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<h1>{% trans "Chart Diagnostics" %}</h1>
<p>{% trans "This page helps diagnose why the Analysis tab might show no charts." %}</p>

<h2>{% trans "System-wide" %}</h2>
<table aria-label="{% trans 'System-wide diagnostics' %}">
    <tbody>
        <tr>
            <th scope="row">{% trans "Library metrics" %}</th>
            <td>{{ lib_metrics }}</td>
            <td>{% if lib_metrics == 0 %}<mark>{% trans "Missing! Run seed command." %}</mark>{% else %}{% trans "OK" %}{% endif %}</td>
        </tr>
        <tr>
            <th scope="row">{% trans "PlanTargetMetric links" %}</th>
            <td>{{ total_ptm }}</td>
            <td>{% if total_ptm == 0 %}<mark>{% trans "None! Metrics not linked to targets." %}</mark>{% else %}{% trans "OK" %}{% endif %}</td>
        </tr>
    </tbody>
</table>

<h2>{% blocktrans %}Participant: {{ record_id }}{% endblocktrans %}</h2>
<form method="get" style="margin-bottom: 1rem;">
    <label for="client">{% trans "Check different participant:" %}</label>
    <input type="text" name="client" id="client" value="{{ record_id }}" placeholder="{% trans "e.g., DEMO-001" %}">
    <button type="submit">{% trans "Check" %}</button>
</form>

{% if client_data %}
<table aria-label="{% blocktrans %}Participant {{ record_id }} diagnostics{% endblocktrans %}">
    <tbody>
        <tr>
            <th scope="row">{% trans "Active targets" %}</th>
            <td>{{ client_data.target_count }}</td>
        </tr>
        {% for target in client_data.targets %}
        <tr>
            <td style="padding-left: 2rem;">{{ target.name }}</td>
            <td>{% blocktrans with count=target.metric_count %}{{ count }} metrics linked{% endblocktrans %}</td>
        </tr>
        {% endfor %}
        <tr>
            <th scope="row">{% trans "Full notes" %}</th>
            <td>{{ client_data.full_notes }}</td>
        </tr>
        <tr>
            <th scope="row">{% trans "Quick notes" %}</th>
            <td>{{ client_data.quick_notes }}</td>
        </tr>
        <tr>
            <th scope="row">{% trans "ProgressNoteTarget entries" %}</th>
            <td>{{ client_data.pnt_count }}</td>
        </tr>
        <tr>
            <th scope="row">{% trans "MetricValue entries" %}</th>
            <td>{{ client_data.mv_count }}</td>
        </tr>
    </tbody>
</table>
{% else %}
<p><mark>{% blocktrans %}Participant "{{ record_id }}" not found.{% endblocktrans %}</mark></p>
{% endif %}

<h2>{% trans "Diagnosis" %}</h2>
{% if diagnosis %}
<article class="{% if diagnosis_type == 'error' %}pico-background-red-500{% elif diagnosis_type == 'warning' %}pico-background-yellow-500{% else %}pico-background-green-500{% endif %}">
    <p><strong>{{ diagnosis }}</strong></p>
</article>
{% endif %}

{% if chart_simulation %}
<h2>{% blocktrans with count=charts_would_show %}Chart Simulation ({{ count }} would display){% endblocktrans %}</h2>
<p>{% trans "This shows exactly what the Analysis tab queries for each target/metric combination:" %}</p>
<table aria-label="{% trans 'Chart simulation' %}">
    <thead>
        <tr>
            <th scope="col">{% trans "Target" %}</th>
            <th scope="col">{% trans "Metric" %}</th>
            <th scope="col">{% trans "Values Found" %}</th>
            <th scope="col">{% trans "Numeric Values" %}</th>
            <th scope="col">{% trans "Would Show Chart?" %}</th>
        </tr>
    </thead>
    <tbody>
        {% for sim in chart_simulation %}
        <tr>
            <td>{{ sim.target }}</td>
            <td>{{ sim.metric }}</td>
            <td>{{ sim.values_found }}</td>
            <td>{{ sim.numeric_values }}</td>
            <td>{% if sim.would_show %}<mark style="background: #90EE90;">{% trans "YES" %}</mark>{% else %}<mark style="background: #FFB6C1;">{% trans "NO" %}</mark>{% endif %}</td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5"><em>{% trans "No target/metric combinations found for this participant." %}</em></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}

<h2>{% trans "How Charts Work" %}</h2>
<ol>
    <li><strong>{% trans "Library metrics" %}</strong> {% trans "must be seeded (run" %} <code>python manage.py seed</code>)</li>
    <li><strong>{% trans "Targets" %}</strong> {% trans "must have metrics assigned (in the Plan tab)" %}</li>
    <li><strong>{% trans "Full notes" %}</strong> {% trans "must be created (not quick notes)" %}</li>
    <li><strong>{% trans "Metric values" %}</strong> {% trans "must be recorded when creating full notes" %}</li>
</ol>

<p><a href="{% url 'admin_settings:dashboard' %}">&larr; {% trans "Back to Admin Settings" %}</a></p>
{% endblock %}
