{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Instance Settings" %} â€” {{ site.product_name|default:"KoNote2" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Instance Settings" %}</h1>
    <p>{% trans "Configure branding, date format, and session behaviour." %}</p>
</hgroup>

<form method="post">
    {% csrf_token %}

    <fieldset>
        <legend>{% trans "Branding & Display" %}</legend>
        {% for field in form %}
            {% if field.name == "product_name" or field.name == "support_email" or field.name == "logo_url" or field.name == "date_format" or field.name == "session_timeout_minutes" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <fieldset>
        <legend>{% trans "Document Storage" %}</legend>
        <p><small>{% trans 'Connect to an external document storage system (SharePoint or Google Drive) to show a "Open Documents Folder" button on participant records.' %}</small></p>

        {% for field in form %}
            {% if field.name == "document_storage_provider" or field.name == "document_storage_url_template" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}

        <div id="test-url-container" style="margin-top: 1rem;">
            <a id="test-url-link"
               href="#"
               target="_blank"
               rel="noopener noreferrer"
               role="button"
               class="outline secondary"
               style="display: none;">
                {% trans "Test with sample Record ID: REC-2024-001" %}
            </a>
        </div>
    </fieldset>

    <fieldset>
        <legend>{% trans "Privacy Officer" %}</legend>
        <p><small>{% trans "Contact details displayed in privacy notices, erasure communications, and data access responses (PIPEDA compliance)." %}</small></p>

        {% for field in form %}
            {% if field.name == "privacy_officer_name" or field.name == "privacy_officer_email" %}
            <label for="{{ field.id_for_label }}">
                {{ field.label }}
                {% if field.field.required %}<abbr title="{% trans 'required' %}">*</abbr>{% endif %}
            </label>
            {{ field }}
            {% if field.help_text %}<small>{{ field.help_text }}</small>{% endif %}
            {% if field.errors %}
            <small class="badge badge-danger">{{ field.errors.0 }}</small>
            {% endif %}
            {% endif %}
        {% endfor %}
    </fieldset>

    <div role="group">
        <button type="submit">{% trans "Save Changes" %}</button>
        <a href="{% url 'admin_settings:dashboard' %}" role="button" class="outline">{% trans "Back" %}</a>
    </div>
</form>

<script>
(function() {
    const providerSelect = document.getElementById('id_document_storage_provider');
    const templateInput = document.getElementById('id_document_storage_url_template');
    const testLink = document.getElementById('test-url-link');
    const sampleRecordId = 'REC-2024-001';

    function updateTestLink() {
        const provider = providerSelect.value;
        const template = templateInput.value.trim();

        if (provider === 'none' || !template) {
            testLink.style.display = 'none';
            return;
        }

        const testUrl = template.replace('{record_id}', sampleRecordId);
        testLink.href = testUrl;
        testLink.style.display = 'inline-block';
    }

    providerSelect.addEventListener('change', updateTestLink);
    templateInput.addEventListener('input', updateTestLink);

    // Initial state
    updateTestLink();
})();
</script>
{% endblock %}
