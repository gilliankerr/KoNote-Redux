{% load i18n %}
<!-- Partial: Notes tab content -->
<div class="action-bar">
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{{ term.quick_note|default:"Quick Note" }}</a>
    <a href="{% url 'notes:note_create' client_id=client.pk %}" role="button" class="outline">{% blocktrans with note=term.progress_note|default:"Note" %}Full {{ note }}{% endblocktrans %}</a>
</div>

<!-- Filters (open by default, collapsible for power users) -->
<details open class="filter-bar">
    <summary>{% trans "Filter notes" %}</summary>
    <form method="get" action="{% url 'notes:note_list' client_id=client.pk %}">
        <div class="grid">
            <label>
                {% trans "Type" %}
                <select name="type">
                    <option value="">{% trans "All types" %}</option>
                    <option value="quick" {% if filter_type == "quick" %}selected{% endif %}>{% trans "Quick notes" %}</option>
                    <option value="full" {% if filter_type == "full" %}selected{% endif %}>{% trans "Full notes" %}</option>
                </select>
            </label>
            <label>
                {% trans "Author" %}
                <select name="author">
                    <option value="">{% trans "All staff" %}</option>
                    <option value="mine" {% if filter_author == "mine" %}selected{% endif %}>{% trans "My notes only" %}</option>
                </select>
            </label>
            <label>
                {% trans "From date" %}
                <input type="date" name="date_from" value="{{ filter_date_from }}">
            </label>
            <label>
                {% trans "To date" %}
                <input type="date" name="date_to" value="{{ filter_date_to }}">
            </label>
        </div>
        <div role="group">
            <button type="submit" class="outline">{% trans "Apply filters" %}</button>
            <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Clear" %}</a>
        </div>
    </form>
</details>

{% if page %}
<div id="notes-timeline">
    {% for note in page %}
    <div class="note-row" id="note-{{ note.pk }}">
        <div class="note-row-header">
            {% if note.note_type == "quick" %}
                <span class="badge badge-info">{{ term.quick_note|default:"Quick" }}</span>
            {% else %}
                <span class="badge badge-success">{% trans "Full" %}</span>
            {% endif %}
            {% if note.status == "cancelled" %}
                <span class="badge badge-danger">{% trans "Cancelled" %}</span>
            {% endif %}
            <strong>{{ note.effective_date|date:"Y-m-d" }}</strong>
            <span class="note-author">{% if note.author %}{{ note.author.display_name|default:note.author }}{% else %}{% trans "(unknown)" %}{% endif %}{% if note.author_program %} ({{ note.author_program.name }}){% endif %}</span>
        </div>
        {% if note.status == "cancelled" %}
            <p class="note-row-text"><del>{{ note.notes_text|truncatechars:200 }}</del></p>
            {% if note.status_reason %}<p class="text-sm secondary">{% trans "Reason:" %} {{ note.status_reason }}</p>{% endif %}
        {% else %}
            <p class="note-row-text">{{ note.notes_text|truncatechars:200 }}</p>
        {% endif %}
        <div class="note-row-footer">
            <a href="#"
               hx-get="{% url 'notes:note_detail' note_id=note.pk %}"
               hx-target="#note-{{ note.pk }}"
               hx-swap="innerHTML"
               hx-indicator="#loading-bar">{% trans "View details" %}</a>
        </div>
    </div>
    {% endfor %}
</div>

{% if page.has_other_pages %}
<nav class="pagination" aria-label="{% trans 'Notes pagination' %}">
    {% if page.has_previous %}
    <a href="?page={{ page.previous_page_number }}&type={{ filter_type }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}">{% trans "Previous" %}</a>
    {% else %}
    <span class="secondary">{% trans "Previous" %}</span>
    {% endif %}
    {% blocktrans with current=page.number total=page.paginator.num_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}
    {% if page.has_next %}
    <a href="?page={{ page.next_page_number }}&type={{ filter_type }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}">{% trans "Next" %}</a>
    {% else %}
    <span class="secondary">{% trans "Next" %}</span>
    {% endif %}
</nav>
{% endif %}

{% else %}
<div class="empty-state">
    <p>{% blocktrans with notes=term.progress_note|default:"notes" %}No {{ notes }} recorded yet.{% endblocktrans %}</p>
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{% trans "Add the first note" %}</a>
</div>
{% endif %}
