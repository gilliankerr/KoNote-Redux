{% load i18n %}
<!-- Partial: Notes tab content -->
{% if is_admin_only %}
<p class="notice" role="status">
    <small>{% blocktrans with programme=term.program|default:"programme" %}You are an administrator without {{ programme }} assignments. To see data, ask another admin to assign you a {{ programme }} role.{% endblocktrans %}</small>
</p>
{% endif %}
{% if active_service_model != "group" %}
<div class="action-bar">
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{{ term.quick_note|default:"Quick Note" }}</a>
    <a href="{% url 'notes:note_create' client_id=client.pk %}" role="button" class="outline">{% blocktrans with note=term.progress_note|default:"Note" %}Full {{ note }}{% endblocktrans %}</a>
</div>
{% endif %}

<!-- Search and filters -->
<form method="get" action="{% url 'notes:note_list' client_id=client.pk %}">
    <div class="note-search-field">
        <label for="note-search">{% trans "Search notes" %}</label>
        <input type="search"
               id="note-search"
               name="q"
               placeholder="{% trans 'Search note content...' %}"
               value="{{ search_query }}"
               aria-label="{% trans 'Search note content' %}">
    </div>

    <!-- Filters (collapsed by default, expand to refine) -->
    <details class="filter-bar"{% if active_filter_count %} open{% endif %}>
        <summary>
            {% trans "Filter notes" %}{% if active_filter_count %}
                <span class="badge badge-info">{{ active_filter_count }}</span>
            {% endif %}
        </summary>
        <div class="grid">
            <label>
                {% trans "Interaction" %}
                <select name="interaction">
                    <option value="">{% trans "All interactions" %}</option>
                    {% for value, label in interaction_choices %}
                    <option value="{{ value }}" {% if filter_interaction == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>
                {% trans "Author" %}
                <select name="author">
                    <option value="">{% trans "All staff" %}</option>
                    <option value="mine" {% if filter_author == "mine" %}selected{% endif %}>{% trans "My notes only" %}</option>
                </select>
            </label>
            {% if show_program_ui %}
            <label>
                {% trans "Program" %}
                <select name="program">
                    <option value="">{% trans "All programs" %}</option>
                    {% for prog in accessible_programs %}
                    <option value="{{ prog.pk }}" {% if filter_program == prog.pk|stringformat:"d" %}selected{% endif %}>{{ prog.name }}</option>
                    {% endfor %}
                </select>
            </label>
            {% endif %}
            <label>
                {% trans "From date" %}
                <input type="date" name="date_from" value="{{ filter_date_from }}">
            </label>
            <label>
                {% trans "To date" %}
                <input type="date" name="date_to" value="{{ filter_date_to }}">
            </label>
        </div>
        <div role="group">
            <button type="submit" class="outline">{% trans "Apply filters" %}</button>
            <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Clear" %}</a>
        </div>
    </details>
</form>

{% if page %}
<div id="notes-timeline">
    {% for note in page %}
    <article class="note-card note-card--{{ note.interaction_type }}{% if note.status == 'cancelled' %} note-card--cancelled{% endif %}"
             id="note-{{ note.pk }}"
             aria-labelledby="note-{{ note.pk }}-heading">
        {% include "notes/_note_card.html" with note=note %}
    </article>
    {% endfor %}
</div>

{% if page.has_other_pages %}
<nav class="pagination" aria-label="{% trans 'Notes pagination' %}">
    {% if page.has_previous %}
    <a href="?page={{ page.previous_page_number }}&q={{ search_query }}&interaction={{ filter_interaction }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}&program={{ filter_program }}">{% trans "Previous" %}</a>
    {% else %}
    <span class="secondary">{% trans "Previous" %}</span>
    {% endif %}
    {% blocktrans with current=page.number total=page.paginator.num_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}
    {% if page.has_next %}
    <a href="?page={{ page.next_page_number }}&q={{ search_query }}&interaction={{ filter_interaction }}&author={{ filter_author }}&date_from={{ filter_date_from }}&date_to={{ filter_date_to }}&program={{ filter_program }}">{% trans "Next" %}</a>
    {% else %}
    <span class="secondary">{% trans "Next" %}</span>
    {% endif %}
</nav>
{% endif %}

{% elif search_query %}
<div class="empty-state">
    <p>{% blocktrans with query=search_query %}No notes match "{{ query }}".{% endblocktrans %}</p>
    <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline">{% trans "Clear search" %}</a>
</div>
{% else %}
<div class="empty-state">
    <p>{% blocktrans with notes=term.progress_note|default:"notes" %}No {{ notes }} recorded yet.{% endblocktrans %}</p>
    {% if active_service_model != "group" %}
    <a href="{% url 'notes:quick_note_create' client_id=client.pk %}" role="button">{% trans "Add the first note" %}</a>
    {% endif %}
</div>
{% endif %}
