{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %} â€” {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block content %}
{% include "_breadcrumbs.html" %}
<hgroup>
    <h1>{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %}</h1>
    <p>{{ client.first_name }} {{ client.last_name }}</p>
</hgroup>

<form method="post" data-autosave data-client-id="{{ client.pk }}" data-form-type="full">
    {% csrf_token %}

    <!-- Template (determines note structure) -->
    <label for="{{ form.template.id_for_label }}">{% trans "Template" %}</label>
    {{ form.template }}
    {% if form.template.errors %}<small class="error" role="alert">{{ form.template.errors.0 }}</small>{% endif %}

    <!-- Interaction type â€” pre-fills from template's default -->
    <label for="{{ form.interaction_type.id_for_label }}">{% trans "Interaction type" %}</label>
    {{ form.interaction_type }}
    {% if form.interaction_type.errors %}<small class="error" id="interaction-type-error" role="alert">{{ form.interaction_type.errors.0 }}</small>{% endif %}

    <!-- Session date â€” pre-filled with today -->
    <label for="{{ form.session_date.id_for_label }}">{% trans "Session Date" %}</label>
    {{ form.session_date }}
    <small>{{ form.session_date.help_text }}</small>
    {% if form.session_date.errors %}<small class="error" role="alert">{{ form.session_date.errors.0 }}</small>{% endif %}

    <!-- Target selection â€” staff pick which targets they worked on -->
    {% if target_forms %}
    <fieldset>
        <legend>{% blocktrans with targets=term.target_plural|default:"targets" %}Which {{ targets }} did you work on?{% endblocktrans %}</legend>
        <small>{% blocktrans with targets=term.target_plural|default:"targets" %}Tick the {{ targets }} you want to record against. Only selected ones will appear below.{% endblocktrans %}</small>
        {% for tf in target_forms %}
        <label class="checkbox-item">
            <input type="checkbox" class="target-selector" data-target-id="{{ tf.target.pk }}">
            <span class="checkbox-label-text">
                {{ tf.target.name }}
                <small class="secondary">{{ tf.target.plan_section.name }}</small>
            </span>
        </label>
        {% endfor %}
    </fieldset>

    <!-- Target entries â€” one accordion per active target, hidden until selected -->
    <h2>{{ term.target_plural|default:"Targets" }}</h2>
    {% for tf in target_forms %}
    <details id="target-detail-{{ tf.target.pk }}" class="target-entry" hidden>
        <summary>
            {{ tf.target.name }}
            <small>â€” {{ tf.target.plan_section.name }}</small>
        </summary>

        <!-- Hidden target ID -->
        {{ tf.note_form.target_id }}

        <label for="{{ tf.note_form.notes.id_for_label }}">{% blocktrans with target=term.target|default:"target" %}Notes for this {{ target }}{% endblocktrans %}</label>
        {{ tf.note_form.notes }}
        {% if tf.note_form.notes.errors %}<small class="error" role="alert">{{ tf.note_form.notes.errors.0 }}</small>{% endif %}

        {% if tf.metric_forms %}
        <h3>{{ term.metric_plural|default:"Metrics" }}</h3>
        {% for mf in tf.metric_forms %}
        {{ mf.metric_def_id }}
        <label for="{{ mf.value.id_for_label }}">{{ mf.value.label }}</label>
        {{ mf.value }}
        {% if mf.value.help_text %}<small>{{ mf.value.help_text }}</small>{% endif %}
        {% if mf.value.errors %}<small class="error" role="alert">{{ mf.value.errors.0 }}</small>{% endif %}
        {% endfor %}
        {% endif %}
    </details>
    {% endfor %}
    {% else %}
    <p class="empty-state">{% blocktrans with targets=term.target_plural|default:"targets" %}No active {{ targets }} found.{% endblocktrans %} <a href="{% url 'plans:plan_view' client_id=client.pk %}">{% trans "Create a plan" %}</a> {% trans "first." %}</p>
    {% endif %}

    <!-- Summary -->
    <label for="{{ form.summary.id_for_label }}">{% trans "Summary (optional)" %}</label>
    {{ form.summary }}
    {% if form.summary.errors %}<small class="error" role="alert">{{ form.summary.errors.0 }}</small>{% endif %}

    <!-- Follow-up date (optional) -->
    <label for="{{ form.follow_up_date.id_for_label }}">{% trans "Follow up by" %}</label>
    {{ form.follow_up_date }}
    <small>{% trans "(optional â€” adds to your home page reminders)" %}</small>
    {% if form.follow_up_date.errors %}<small class="error" role="alert">{{ form.follow_up_date.errors.0 }}</small>{% endif %}

    <!-- Participant reflection section -->
    <div class="participant-reflection" role="region" aria-labelledby="reflection-heading">
        <h3 id="reflection-heading">
            <span class="reflection-icon" aria-hidden="true">ðŸ’¬</span>
            {% blocktrans with client=term.client|default:"Participant" %}{{ client }}'s Reflection{% endblocktrans %}
        </h3>
        <p class="reflection-prompt">
            {% trans "Ask:" %} <em>"{% trans "What's one thing you're taking away from today?" %}"</em>
        </p>
        <label for="{{ form.participant_reflection.id_for_label }}" class="visually-hidden">
            {% blocktrans with client=term.client|default:"Participant" %}{{ client }}'s response{% endblocktrans %}
        </label>
        {{ form.participant_reflection }}
        {% if form.participant_reflection.errors %}<small class="error" role="alert">{{ form.participant_reflection.errors.0 }}</small>{% endif %}
        <small class="reflection-help">{% trans "Record their words, not your interpretation. Even a brief phrase captures their voice." %}</small>
    </div>

    <!-- Sticky footer with confirmation and save -->
    <div class="sticky-form-footer{% if form.consent_confirmed.errors %} has-error{% endif %}" role="region" aria-label="{% trans 'Confirm and save' %}">
        <div class="sticky-form-footer-inner">
            <div class="consent-section">
                <label for="{{ form.consent_confirmed.id_for_label }}">
                    {{ form.consent_confirmed }}
                    {% trans "We created this note together" %}
                </label>
                {% if form.consent_confirmed.errors %}
                <small class="error" role="alert">{{ form.consent_confirmed.errors.0 }}</small>
                {% endif %}
            </div>
            <span class="autosave-indicator" id="autosave-status" hidden aria-live="polite" role="status">
                <span class="status-text">{% trans "Saved" %}</span>
            </span>
            <div class="button-group">
                <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
                <button type="submit">{% blocktrans with note=term.progress_note|default:"Note" %}Save {{ note }}{% endblocktrans %}</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
{{ template_defaults|json_script:"template-defaults" }}
<script>
// Show/hide target accordions based on checkbox selection
document.querySelectorAll(".target-selector").forEach(function (cb) {
    cb.addEventListener("change", function () {
        var targetId = this.getAttribute("data-target-id");
        var detail = document.getElementById("target-detail-" + targetId);
        if (detail) {
            detail.hidden = !this.checked;
            if (this.checked) { detail.open = true; }
        }
    });
});

// Auto-fill interaction type from template's default
var templateSelect = document.querySelector('[name="template"]');
var interactionSelect = document.querySelector('[name="interaction_type"]');
var defaultsEl = document.getElementById("template-defaults");
if (templateSelect && interactionSelect && defaultsEl) {
    var templateDefaults = JSON.parse(defaultsEl.textContent);
    templateSelect.addEventListener("change", function () {
        var tmplId = this.value;
        if (tmplId && templateDefaults[tmplId]) {
            interactionSelect.value = templateDefaults[tmplId];
        }
    });
}
</script>
{% endblock %}
