{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %} — {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block content %}
{% include "_breadcrumbs.html" %}
<hgroup>
    <h1>{% blocktrans with note=term.progress_note|default:"Progress Note" %}New {{ note }}{% endblocktrans %}</h1>
    <p>{{ client.first_name }} {{ client.last_name }}</p>
</hgroup>

<form method="post" data-autosave data-client-id="{{ client.pk }}" data-form-type="full">
    {% csrf_token %}

    <!-- Template (determines note structure) -->
    <label for="{{ form.template.id_for_label }}">{% trans "Template" %}</label>
    {{ form.template }}
    {% if form.template.errors %}<small class="error" role="alert">{{ form.template.errors.0 }}</small>{% endif %}

    <!-- Session date — pre-filled with today -->
    <label for="{{ form.session_date.id_for_label }}">{% trans "Session Date" %}</label>
    {{ form.session_date }}
    <small>{{ form.session_date.help_text }}</small>
    {% if form.session_date.errors %}<small class="error" role="alert">{{ form.session_date.errors.0 }}</small>{% endif %}

    <!-- Target selection — staff pick which targets they worked on -->
    {% if target_forms %}
    <fieldset>
        <legend>{% blocktrans with targets=term.target_plural|default:"targets" %}Which {{ targets }} did you work on?{% endblocktrans %}</legend>
        <small>{% blocktrans with targets=term.target_plural|default:"targets" %}Tick the {{ targets }} you want to record against. Only selected ones will appear below.{% endblocktrans %}</small>
        {% for tf in target_forms %}
        <label>
            <input type="checkbox" class="target-selector" data-target-id="{{ tf.target.pk }}">
            {{ tf.target.name }}
            <small class="secondary">— {{ tf.target.plan_section.name }}</small>
        </label>
        {% endfor %}
    </fieldset>

    <!-- Target entries — one accordion per active target, hidden until selected -->
    <h2>{{ term.target_plural|default:"Targets" }}</h2>
    {% for tf in target_forms %}
    <details id="target-detail-{{ tf.target.pk }}" class="target-entry" hidden>
        <summary>
            {{ tf.target.name }}
            <small>— {{ tf.target.plan_section.name }}</small>
        </summary>

        <!-- Hidden target ID -->
        {{ tf.note_form.target_id }}

        <label for="{{ tf.note_form.notes.id_for_label }}">{% blocktrans with target=term.target|default:"target" %}Notes for this {{ target }}{% endblocktrans %}</label>
        {{ tf.note_form.notes }}
        {% if tf.note_form.notes.errors %}<small class="error" role="alert">{{ tf.note_form.notes.errors.0 }}</small>{% endif %}

        {% if tf.metric_forms %}
        <h4>{{ term.metric_plural|default:"Metrics" }}</h4>
        {% for mf in tf.metric_forms %}
        {{ mf.metric_def_id }}
        <label for="{{ mf.value.id_for_label }}">{{ mf.value.label }}</label>
        {{ mf.value }}
        {% if mf.value.help_text %}<small>{{ mf.value.help_text }}</small>{% endif %}
        {% if mf.value.errors %}<small class="error" role="alert">{{ mf.value.errors.0 }}</small>{% endif %}
        {% endfor %}
        {% endif %}
    </details>
    {% endfor %}
    {% else %}
    <p class="empty-state">{% blocktrans with targets=term.target_plural|default:"targets" %}No active {{ targets }} found.{% endblocktrans %} <a href="{% url 'plans:plan_view' client_id=client.pk %}">{% trans "Create a plan" %}</a> {% trans "first." %}</p>
    {% endif %}

    <!-- Summary -->
    <label for="{{ form.summary.id_for_label }}">{% trans "Summary (optional)" %}</label>
    {{ form.summary }}
    {% if form.summary.errors %}<small class="error" role="alert">{{ form.summary.errors.0 }}</small>{% endif %}

    <!-- Follow-up date (optional) -->
    <label for="{{ form.follow_up_date.id_for_label }}">{% trans "Follow up by" %}</label>
    {{ form.follow_up_date }}
    <small>{% trans "(optional — adds to your home page reminders)" %}</small>
    {% if form.follow_up_date.errors %}<small class="error" role="alert">{{ form.follow_up_date.errors.0 }}</small>{% endif %}

    <!-- Consent confirmation -->
    <fieldset>
        <label>
            {{ form.consent_confirmed }}
            {% trans "I confirm verbal consent was obtained" %}
        </label>
        <small>{% blocktrans with client=term.client|default:"client" %}The {{ client }} has given verbal consent to record notes about this session.{% endblocktrans %}</small>
        {% if form.consent_confirmed.errors %}
        <small class="error" role="alert">{{ form.consent_confirmed.errors.0 }}</small>
        {% endif %}
    </fieldset>

    <div role="group">
        <button type="submit">{% blocktrans with note=term.progress_note|default:"Note" %}Save {{ note }}{% endblocktrans %}</button>
        <a href="{% url 'notes:note_list' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
    </div>
</form>
{% endblock %}

{% block extra_scripts %}
<script>
// Show/hide target accordions based on checkbox selection
document.querySelectorAll(".target-selector").forEach(function (cb) {
    cb.addEventListener("change", function () {
        var targetId = this.getAttribute("data-target-id");
        var detail = document.getElementById("target-detail-" + targetId);
        if (detail) {
            detail.hidden = !this.checked;
            if (this.checked) { detail.open = true; }
        }
    });
});
</script>
{% endblock %}
