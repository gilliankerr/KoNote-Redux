{% load i18n %}
<!-- HTMX partial: expanded view of a single note -->
<div class="note-detail-content" tabindex="-1">
<header>
    <div>
        <strong>{{ note.get_interaction_type_display }} &mdash; {{ note.effective_date|date:"M d, Y" }}</strong>
        {% if note.status == "cancelled" %}
            <span class="badge badge-danger">{% trans "Cancelled" %}</span>
        {% endif %}
        <br>
        {% if note.author %}{{ note.author.display_name|default:note.author }}{% else %}{% trans "(unknown author)" %}{% endif %}
        {% if note.author_program %}
            <small>({{ note.author_program.translated_name }})</small>
        {% endif %}
        {% if note.template %}
            <small>| {% trans "Template:" %} {{ note.template.name }}</small>
        {% endif %}
    </div>
</header>

{% if note.status == "cancelled" %}
    <p><del>{{ note.notes_text }}</del></p>
    {% if note.status_reason %}<p><small>{% trans "Cancellation reason:" %} {{ note.status_reason }}</small></p>{% endif %}
{% else %}
    {% if note.notes_text %}
        <p>{{ note.notes_text }}</p>
    {% endif %}

    {% if target_entries %}
    {% for entry in target_entries %}
    {% if entry.plan_target %}
    <details open>
        <summary>{{ entry.plan_target.name }}</summary>
        {% if entry.client_words %}<p><strong>{% trans "In their words:" %}</strong> "{{ entry.client_words }}"</p>{% endif %}
        {% if entry.progress_descriptor %}<p><span class="badge badge-neutral">{{ entry.get_progress_descriptor_display }}</span></p>{% endif %}
        {% if entry.notes %}<p>{{ entry.notes }}</p>{% endif %}
        {% if entry.metric_values.all %}
        <table>
            <thead><tr><th scope="col">{{ term.metric|default:"Metric" }}</th><th scope="col">{% trans "Value" %}</th></tr></thead>
            <tbody>
            {% for mv in entry.metric_values.all %}
            {% if mv.metric_def %}
            <tr>
                <td>{{ mv.metric_def.name }}{% if mv.metric_def.unit %} ({{ mv.metric_def.unit }}){% endif %}</td>
                <td>{{ mv.value }}</td>
            </tr>
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </details>
    {% endif %}
    {% endfor %}
    {% endif %}

    {% if note.engagement_observation %}
        <p><strong>{% trans "Engagement:" %}</strong> {{ note.get_engagement_observation_display }}</p>
    {% endif %}

    {% if note.participant_reflection %}
        <p><strong>{% trans "Reflection:" %}</strong> "{{ note.participant_reflection }}"</p>
    {% endif %}

    {% if note.participant_suggestion %}
        <p><strong>{% trans "Suggestion:" %}</strong> "{{ note.participant_suggestion }}"
            {% if note.suggestion_priority %}
                <span class="badge badge-neutral">{{ note.get_suggestion_priority_display }}</span>
            {% endif %}
        </p>
    {% endif %}

    {% if note.summary %}
        <h3>{% trans "Summary" %}</h3>
        <p>{{ note.summary }}</p>
    {% endif %}
{% endif %}

<footer>
    {% if note.status != "cancelled" %}
    <a href="{% url 'notes:note_cancel' note_id=note.pk %}" class="secondary">{% trans "Cancel this note" %}</a>
    {% endif %}
    <a href="#"
       hx-get="{% url 'notes:note_summary' note_id=note.pk %}"
       hx-target="#note-{{ note.pk }}"
       hx-swap="innerHTML"
       class="secondary">{% trans "Collapse" %}</a>
</footer>
</div>
