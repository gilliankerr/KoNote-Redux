{% load i18n %}
<!-- Partial: Plan tab content -->
{% if can_edit and active_service_model != "group" %}
<div class="action-bar">
    <a href="{% url 'plans:section_create' client_id=client.pk %}" role="button" class="outline">
        {% blocktrans with section=term.section|default:"Section" %}Add {{ section }}{% endblocktrans %}
    </a>
    <a href="{% url 'plan_templates:template_apply_list' client_id=client.pk %}" role="button" class="outline secondary">
        {% trans "Apply Template" %}
    </a>
</div>
{% else %}
<p class="notice" role="status">
    <small>{% blocktrans with client=term.client|default:"participant" programme=term.program|default:"programme" %}View only â€” to edit this plan, you must be assigned to a {{ programme }} this {{ client }} is enrolled in.{% endblocktrans %}</small>
</p>
{% endif %}

{% if show_section_form %}
<article aria-label="{% trans 'Add section form' %}">
    <header><h2>{% blocktrans with section=term.section|default:"Section" %}Add {{ section }}{% endblocktrans %}</h2></header>
    <form method="post" action="{% url 'plans:section_create' client_id=client.pk %}">
        {% csrf_token %}
        {% for field in section_form %}
        <div class="form-row">
            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
            {{ field }}
            {% if field.errors %}
            <small class="error" role="alert">{{ field.errors.0 }}</small>
            {% endif %}
        </div>
        {% endfor %}
        <div role="group">
            <button type="submit">{% trans "Save" %}</button>
            <a href="{% url 'plans:plan_view' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
        </div>
    </form>
</article>
{% endif %}

{% if active_sections %}
{% if show_grouping and grouped_active_sections %}
{# Multi-program: group sections by program with colour headers #}
{% for program_id, group in grouped_active_sections.items %}
<div class="program-group" style="border-left: 3px solid {{ group.program.colour_hex|default:'var(--pico-muted-border-color)' }};">
    <h2 class="program-group-heading">
        <span class="program-dot" style="background-color: {{ group.program.colour_hex }}" aria-hidden="true"></span>
        {{ group.program.translated_name }}
    </h2>
    {% for section in group.sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit hide_program_dot=True %}
    </article>
    {% endfor %}
</div>
{% endfor %}
{% if general_sections %}
<div class="program-group">
    <h2 class="program-group-heading">{% trans "General" %}</h2>
    {% for section in general_sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit hide_program_dot=True %}
    </article>
    {% endfor %}
</div>
{% endif %}
{% else %}
{# Single program or specific CONF9: flat list, no group headers #}
{% for section in active_sections %}
<article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
    {% include "plans/_section.html" with section=section can_edit=can_edit %}
</article>
{% endfor %}
{% endif %}
{% endif %}

{% if inactive_sections %}
<details>
    <summary>{% blocktrans with sections=term.section_plural|default:"sections" count=inactive_sections|length %}Completed & deactivated {{ sections }} ({{ count }}){% endblocktrans %}</summary>
    {% for section in inactive_sections %}
    <article class="section-card" id="section-{{ section.pk }}" aria-label="{{ term.section|default:'Section' }}: {{ section.name }}">
        {% include "plans/_section.html" with section=section can_edit=can_edit %}
    </article>
    {% endfor %}
</details>
{% endif %}

{% if not active_sections and not inactive_sections and not show_section_form %}
<div class="empty-state">
    <p>{% blocktrans with sections=term.section_plural|default:"sections" %}No {{ sections }} yet.{% endblocktrans %}{% if can_edit %} {% trans "Use the button above to add one, or apply a template." %}{% endif %}</p>
</div>
{% endif %}
