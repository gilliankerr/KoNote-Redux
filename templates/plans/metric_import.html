{% extends "base.html" %}

{% block title %}Import {{ term.metric_plural|default:"Metrics" }} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>Import {{ term.metric_plural|default:"Metrics" }}</h1>
    <p>Upload a CSV file to add multiple {{ term.metric_plural|default:"metrics" }} at once.</p>
</hgroup>

{% if parse_errors %}
<article aria-label="Import errors" class="error-box" style="background-color: var(--pico-del-color); padding: 1rem; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
    <strong>Errors found in CSV:</strong>
    <ul style="margin-bottom: 0;">
        {% for error in parse_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
    <p style="margin-top: 1rem; margin-bottom: 0;">Please fix these errors and upload the file again.</p>
</article>
{% endif %}

{% if preview_rows %}
<article aria-label="Preview">
    <header>
        <strong>Preview: {{ preview_rows|length }} {{ term.metric_plural|default:"metrics" }} ready to import</strong>
    </header>
    <table role="grid" aria-label="Metrics to import">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Definition</th>
                <th scope="col">Category</th>
                <th scope="col">Range</th>
                <th scope="col">Unit</th>
            </tr>
        </thead>
        <tbody>
            {% for row in preview_rows %}
            <tr>
                <td>{{ row.name }}</td>
                <td>{{ row.definition|truncatewords:15 }}</td>
                <td>{{ row.category }}</td>
                <td>
                    {% if row.min_value != None or row.max_value != None %}
                        {{ row.min_value|default:"—" }} to {{ row.max_value|default:"—" }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>{{ row.unit|default:"—" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <footer>
        <form method="post">
            {% csrf_token %}
            <div role="group">
                <button type="submit" name="confirm_import" value="1">Import {{ preview_rows|length }} {{ term.metric_plural|default:"Metrics" }}</button>
                <a href="{% url 'plans:metric_import' %}" role="button" class="outline secondary">Start Over</a>
            </div>
        </form>
    </footer>
</article>
{% else %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% for field in form %}
    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
    {{ field }}
    {% if field.help_text %}
    <small>{{ field.help_text }}</small>
    {% endif %}
    {% if field.errors %}
    <small class="error" role="alert">{{ field.errors.0 }}</small>
    {% endif %}
    {% endfor %}

    <div role="group">
        <button type="submit">Upload and Preview</button>
        <a href="{% url 'plans:metric_library' %}" role="button" class="outline secondary">Cancel</a>
    </div>
</form>

<details style="margin-top: 2rem;">
    <summary>CSV Format Instructions</summary>
    <p>Your CSV file should have these columns:</p>
    <table role="grid">
        <thead>
            <tr>
                <th scope="col">Column</th>
                <th scope="col">Required</th>
                <th scope="col">Description</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>name</code></td>
                <td>Yes</td>
                <td>Name of the metric (e.g., "PHQ-9 (Depression)")</td>
            </tr>
            <tr>
                <td><code>definition</code></td>
                <td>Yes</td>
                <td>Description of what this metric measures and how to score it</td>
            </tr>
            <tr>
                <td><code>category</code></td>
                <td>Yes</td>
                <td>One of: {% for key, label in category_choices.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
            </tr>
            <tr>
                <td><code>min_value</code></td>
                <td>No</td>
                <td>Minimum valid value (number)</td>
            </tr>
            <tr>
                <td><code>max_value</code></td>
                <td>No</td>
                <td>Maximum valid value (number)</td>
            </tr>
            <tr>
                <td><code>unit</code></td>
                <td>No</td>
                <td>Unit of measurement (e.g., "score", "days", "%")</td>
            </tr>
        </tbody>
    </table>

    <p><strong>Example CSV:</strong></p>
    <pre style="background: var(--pico-code-background-color); padding: 1rem; overflow-x: auto;">name,definition,category,min_value,max_value,unit
Client Satisfaction,Client satisfaction with services. 1 = very dissatisfied 5 = very satisfied.,general,1,5,score
Days in Program,Number of days enrolled in the program.,general,0,,days</pre>
</details>
{% endif %}
{% endblock %}
