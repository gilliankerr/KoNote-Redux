{% extends "base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with metrics=term.metric_plural|default:"Metrics" %}Import {{ metrics }}{% endblocktrans %} — {{ site.product_name|default:"KoNote2" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% blocktrans with metrics=term.metric_plural|default:"Metrics" %}Import {{ metrics }}{% endblocktrans %}</h1>
    <p>{% blocktrans with metrics=term.metric_plural|default:"metrics" %}Upload a CSV file to add or update {{ metrics }}.{% endblocktrans %}</p>
</hgroup>

{% if parse_errors %}
<article aria-label="{% trans 'Import errors' %}" class="error-box" style="background-color: var(--pico-del-color); padding: 1rem; border-radius: var(--pico-border-radius); margin-bottom: 1rem;">
    <strong>{% trans "Errors found in CSV:" %}</strong>
    <ul style="margin-bottom: 0;">
        {% for error in parse_errors %}
        <li>{{ error }}</li>
        {% endfor %}
    </ul>
    <p style="margin-top: 1rem; margin-bottom: 0;">{% trans "Please fix these errors and upload the file again." %}</p>
</article>
{% endif %}

{% if preview_rows %}
<article aria-label="{% trans 'Preview' %}">
    <header>
        <strong>{% blocktrans with count=preview_rows|length metrics=term.metric_plural|default:"metrics" %}Preview: {{ count }} {{ metrics }} ready to import{% endblocktrans %}</strong>
        {% if update_count %}
        <br><small>{% blocktrans with new=new_count updated=update_count %}{{ new }} new, {{ updated }} updates to existing{% endblocktrans %}</small>
        {% endif %}
    </header>
    <table role="grid" aria-label="{% trans 'Metrics to import' %}">
        <thead>
            <tr>
                <th scope="col">{% trans "Action" %}</th>
                <th scope="col">{% trans "Name" %}</th>
                <th scope="col">{% trans "Definition" %}</th>
                <th scope="col">{% trans "Category" %}</th>
                <th scope="col">{% trans "Range" %}</th>
                <th scope="col">{% trans "Unit" %}</th>
                <th scope="col">{% trans "Enabled" %}</th>
                <th scope="col">{% trans "Status" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for row in preview_rows %}
            <tr>
                <td>
                    {% if row.action == "update" %}
                    <mark>{% trans "Update" %}</mark>
                    {% else %}
                    <ins>{% trans "New" %}</ins>
                    {% endif %}
                </td>
                <td>{{ row.name }}</td>
                <td>{{ row.definition|truncatewords:15 }}</td>
                <td>{{ row.category }}</td>
                <td>
                    {% if row.min_value != None or row.max_value != None %}
                        {{ row.min_value|default:"—" }} {% trans "to" %} {{ row.max_value|default:"—" }}
                    {% else %}
                        —
                    {% endif %}
                </td>
                <td>{{ row.unit|default:"—" }}</td>
                <td>{% if row.is_enabled %}{% trans "Yes" %}{% else %}{% trans "No" %}{% endif %}</td>
                <td>{{ row.status }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <footer>
        <form method="post">
            {% csrf_token %}
            <div role="group">
                <button type="submit" name="confirm_import" value="1">{% blocktrans with count=preview_rows|length metrics=term.metric_plural|default:"Metrics" %}Import {{ count }} {{ metrics }}{% endblocktrans %}</button>
                <a href="{% url 'plans:metric_import' %}" role="button" class="outline secondary">{% trans "Start Over" %}</a>
            </div>
        </form>
    </footer>
</article>
{% else %}
<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {% for field in form %}
    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
    {{ field }}
    {% if field.help_text %}
    <small>{{ field.help_text }}</small>
    {% endif %}
    {% if field.errors %}
    <small class="error" role="alert">{{ field.errors.0 }}</small>
    {% endif %}
    {% endfor %}

    <div role="group">
        <button type="submit">{% trans "Upload and Preview" %}</button>
        <a href="{% url 'plans:metric_library' %}" role="button" class="outline secondary">{% trans "Cancel" %}</a>
    </div>
</form>

<details style="margin-top: 2rem;">
    <summary>{% trans "CSV Format Instructions" %}</summary>
    <p>{% blocktrans %}The easiest way is to use <strong>Export to CSV</strong> from the Metric Library, edit the file in Excel, then upload it here.{% endblocktrans %}</p>
    <p>{% trans "Your CSV file should have these columns:" %}</p>
    <table role="grid">
        <thead>
            <tr>
                <th scope="col">{% trans "Column" %}</th>
                <th scope="col">{% trans "Required" %}</th>
                <th scope="col">{% trans "Description" %}</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><code>id</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "Metric ID from export. If present, that metric will be updated. If blank, a new metric is created." %}</td>
            </tr>
            <tr>
                <td><code>name</code></td>
                <td>{% trans "Yes" %}</td>
                <td>{% trans "Name of the metric (e.g., \"PHQ-9 (Depression)\")" %}</td>
            </tr>
            <tr>
                <td><code>definition</code></td>
                <td>{% trans "Yes" %}</td>
                <td>{% trans "Description of what this metric measures and how to score it" %}</td>
            </tr>
            <tr>
                <td><code>category</code></td>
                <td>{% trans "Yes" %}</td>
                <td>{% blocktrans %}One of: {% endblocktrans %}{% for key, label in category_choices.items %}{{ key }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
            </tr>
            <tr>
                <td><code>min_value</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "Minimum valid value (number)" %}</td>
            </tr>
            <tr>
                <td><code>max_value</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "Maximum valid value (number)" %}</td>
            </tr>
            <tr>
                <td><code>unit</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "Unit of measurement (e.g., \"score\", \"days\", \"%\")" %}</td>
            </tr>
            <tr>
                <td><code>is_enabled</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "yes or no — whether this metric is available for use (defaults to yes)" %}</td>
            </tr>
            <tr>
                <td><code>status</code></td>
                <td>{% trans "No" %}</td>
                <td>{% trans "active or deactivated (defaults to active)" %}</td>
            </tr>
        </tbody>
    </table>

    <p><strong>{% trans "Example CSV:" %}</strong></p>
    <pre style="background: var(--pico-code-background-color); padding: 1rem; overflow-x: auto;">id,name,definition,category,min_value,max_value,unit,is_enabled,status
,Client Satisfaction,Client satisfaction with services. 1 = very dissatisfied 5 = very satisfied.,general,1,5,score,yes,active
42,PHQ-9 (Depression),Patient Health Questionnaire depression scale.,mental_health,0,27,score,yes,active</pre>
    <p><small>{% trans "Row 1 has no id — it creates a new metric. Row 2 has id 42 — it updates the existing metric with that ID." %}</small></p>
</details>
{% endif %}
{% endblock %}
