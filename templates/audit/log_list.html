{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Audit Log" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block extra_head %}
<style>
    /* BUG-3: Prevent filter dropdowns from truncating labels */
    .audit-filters .grid {
        grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
    }
    .audit-filters select {
        min-width: 12rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <hgroup>
        <h1>{% trans "Audit Log" %}</h1>
        <p>{% trans "Review all system activity. Use filters to narrow results." %}</p>
    </hgroup>

    {# ---- Filter form ---- #}
    <form method="get" action="" role="search" class="audit-filters">
        <div class="grid">
            <label for="date_from">
                {% trans "From" %}
                <input type="date" id="date_from" name="date_from" value="{{ date_from }}">
            </label>
            <label for="date_to">
                {% trans "To" %}
                <input type="date" id="date_to" name="date_to" value="{{ date_to }}">
            </label>
            <label for="user_display">
                {% trans "User" %}
                <input type="text" id="user_display" name="user_display" value="{{ user_display }}" placeholder="{% trans 'Search by name' %}">
            </label>
        </div>
        <div class="grid">
            <label for="action">
                {% trans "Action" %}
                <select id="action" name="action">
                    <option value="">{% trans "All actions" %}</option>
                    {% for value, label in action_choices %}
                    <option value="{{ value }}" {% if action_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </label>
            <label for="resource_type">
                {% trans "Record type" %}
                <input type="text" id="resource_type" name="resource_type" value="{{ resource_type }}" placeholder="{% trans 'e.g. participant, note' %}">
            </label>
            <label for="demo_filter">
                {% trans "Context" %}
                <select id="demo_filter" name="demo_filter">
                    <option value="">{% trans "All activity" %}</option>
                    <option value="real" {% if demo_filter == "real" %}selected{% endif %}>{% trans "Real users only" %}</option>
                    <option value="demo" {% if demo_filter == "demo" %}selected{% endif %}>{% trans "Demo users only" %}</option>
                </select>
            </label>
        </div>
        <div class="grid">
            <div>
                <button type="submit">{% trans "Filter" %}</button>
                <a href="{% url 'audit:audit_log_list' %}" role="button" class="secondary outline" style="margin-left:0.5rem;">{% trans "Clear" %}</a>
            </div>
            <div style="text-align:right;">
                <a href="{% url 'audit:audit_log_export' %}{% if filter_query %}?{{ filter_query }}{% endif %}" role="button" class="contrast outline">{% trans "Export CSV" %}</a>
            </div>
        </div>
    </form>

    {# ---- Results table ---- #}
    {% if page.object_list %}
    <p style="text-align:right; margin-bottom: var(--kn-space-sm);">
        <label style="display:inline-flex; align-items:center; gap:0.5rem; font-size:0.8125rem; cursor:pointer;">
            <input type="checkbox" id="show-advanced-cols" style="width:auto; margin:0;">
            {% trans "Show technical details" %}
        </label>
    </p>
    <figure>
        <table role="grid">
            <thead>
                <tr>
                    <th scope="col">{% trans "Timestamp" %}</th>
                    <th scope="col">{% trans "User" %}</th>
                    <th scope="col">{% trans "Action" %}</th>
                    <th scope="col">{% trans "Record type" %}</th>
                    <th scope="col" class="audit-advanced" hidden>{% trans "IP Address" %}</th>
                    <th scope="col" class="audit-advanced" hidden>{% trans "Record ID" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for entry in page.object_list %}
                <tr{% if entry.is_demo_context %} style="opacity: 0.7;"{% endif %}>
                    <td>{{ entry.event_timestamp|date:"Y-m-d H:i" }}</td>
                    <td>{{ entry.user_display }}{% if entry.is_demo_context %} <small style="color: var(--pico-del-color, #e53935);">(demo)</small>{% endif %}</td>
                    <td>
                        <span class="badge {% if entry.action == 'create' or entry.action == 'post' %}badge-success{% elif entry.action == 'view' or entry.action == 'login' %}badge-info{% elif entry.action == 'update' or entry.action == 'put' or entry.action == 'patch' %}badge-warning{% elif entry.action == 'delete' %}badge-danger{% else %}badge-neutral{% endif %}">
                            {{ entry.get_action_display }}
                        </span>
                    </td>
                    <td>{{ entry.resource_type_display }}</td>
                    <td class="audit-advanced" hidden>{{ entry.ip_address|default:"—" }}</td>
                    <td class="audit-advanced" hidden>{{ entry.resource_id|default:"—" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </figure>

    {# ---- Pagination ---- #}
    {% if page.has_previous or page.has_next %}
    <nav aria-label="{% trans 'Pagination' %}">
        <ul>
            {% if page.has_previous %}
            <li><a href="?page={{ page.previous_page_number }}&{{ filter_query }}">{% trans "Previous" %}</a></li>
            {% endif %}
            <li>{% blocktrans with current=page.number total=page.paginator.num_pages %}Page {{ current }} of {{ total }}{% endblocktrans %}</li>
            {% if page.has_next %}
            <li><a href="?page={{ page.next_page_number }}&{{ filter_query }}">{% trans "Next" %}</a></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <p>{% trans "No audit log entries found. Try adjusting your filters." %}</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    var cb = document.getElementById('show-advanced-cols');
    if (!cb) return;
    cb.addEventListener('change', function() {
        var cells = document.querySelectorAll('.audit-advanced');
        for (var i = 0; i < cells.length; i++) {
            cells[i].hidden = !cb.checked;
        }
    });
})();
</script>
{% endblock %}
