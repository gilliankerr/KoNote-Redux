{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.product_name|default:"KoNote" }}{% endblock %}</title>

    <!-- Pico CSS — classless, accessible defaults -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    {% load static %}
    <!-- Theme (brand identity — swappable per agency) -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">

    <!-- App structure styles -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <a href="#main-content" class="visually-hidden-focusable">{% trans "Skip to main content" %}</a>

    <!-- Loading bar — shown during HTMX requests -->
    <div id="loading-bar" class="loading-bar htmx-indicator"></div>

    {% if user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast">
                <strong>{{ site.product_name|default:"KoNote" }}</strong>
            </a></li>
        </ul>
        <ul>
            {% if not is_admin_only %}
            <li><a href="/"{% if nav_active == "clients" %} class="nav-active"{% endif %}>{{ term.client_plural|default:"Clients" }}</a></li>
            {% endif %}
            {% if features.programs %}
            <li><a href="/programs/"{% if nav_active == "programs" %} class="nav-active"{% endif %}>{{ term.program_plural|default:"Programs" }}</a></li>
            {% endif %}
            {% if user.is_admin %}
            <li><a href="/reports/export/"{% if nav_active == "reports" %} class="nav-active"{% endif %}>{% trans "Reports" %}</a></li>
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "admin" %} class="nav-active"{% endif %}>{% trans "Admin" %}</summary>
                    <ul role="listbox">
                        <li><a href="/plans/admin/metrics/">{{ term.metric_plural|default:"Metrics" }}</a></li>
                        <li><a href="/admin/templates/">{% trans "Templates" %}</a></li>
                        <li><a href="/events/admin/types/">{% trans "Event Types" %}</a></li>
                        <li><a href="/admin/settings/">{% trans "Settings" %}</a></li>
                        <li><a href="/auth/invites/">{% trans "Invites" %}</a></li>
                        <li><a href="/admin/audit/">{% trans "Audit Log" %}</a></li>
                    </ul>
                </details>
            </li>
            {% endif %}
            <li>
                <details class="dropdown" role="list" dir="rtl">
                    <summary aria-haspopup="listbox">{{ user.display_name }}</summary>
                    <ul role="listbox">
                        <li><a href="/auth/logout/">{% trans "Sign Out" %}</a></li>
                    </ul>
                </details>
            </li>
            <li>
                <!-- Language switcher -->
                <form action="{% url 'set_language' %}" method="post" style="margin: 0;">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <select name="language" onchange="this.form.submit()" aria-label="{% trans 'Select language' %}" style="padding: 0.25rem 0.5rem; min-width: auto;">
                        {% get_current_language as LANGUAGE_CODE %}
                        {% get_available_languages as LANGUAGES %}
                        {% for lang_code, lang_name in LANGUAGES %}
                        <option value="{{ lang_code }}"{% if lang_code == LANGUAGE_CODE %} selected{% endif %}>{{ lang_name }}</option>
                        {% endfor %}
                    </select>
                </form>
            </li>
        </ul>
    </nav>
    {% endif %}

    <main id="main-content" class="container">
        {% if messages %}
        {% for message in messages %}
        <article aria-label="notification" {% if message.tags %}class="{{ message.tags }}"{% endif %}>
            {{ message }}
        </article>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- HTMX error toast — shown by app.js on network/server errors -->
    <div id="htmx-error-toast" class="toast toast-error" role="alert" hidden>
        <span id="htmx-error-toast-message"></span>
        <button type="button" id="htmx-error-toast-close" aria-label="Dismiss" style="background:none;border:none;cursor:pointer;padding:0 0 0 1rem;font-size:1.2rem;color:inherit;">&times;</button>
    </div>

    <footer class="container">
        <small>{{ site.product_name|default:"KoNote" }} &mdash; {% trans "Secure Client Outcome Management" %}</small>
    </footer>

    <!-- HTMX — dynamic interactions without a JS framework -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- Chart.js — for analysis charts (loaded globally for HTMX compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- App JS — CSRF handling, error handlers -->
    <script src="{% static 'js/app.js' %}"></script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
