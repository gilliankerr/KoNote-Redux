{% load i18n %}
{% load static %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.product_name|default:"KoNote2" }}{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" href="{% static 'img/favicon.svg' %}" type="image/svg+xml">
    <link rel="icon" href="{% static 'img/favicon.ico' %}" sizes="any">
    <link rel="apple-touch-icon" href="{% static 'img/apple-touch-icon.png' %}">
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#0d7377">

    <!-- Pico CSS — classless, accessible defaults -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    <!-- Theme (brand identity — swappable per agency) -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">

    <!-- App structure styles -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Loading bar — shown during HTMX requests -->
    <div id="loading-bar" class="loading-bar htmx-indicator"></div>

    {% if user.is_authenticated and user.is_demo %}
    <div class="demo-banner" role="alert" aria-live="polite">
        <strong>{% trans "Demo Mode:" %}</strong> {% blocktrans with name=user.display_name %}You are logged in as {{ name }}. Changes affect demo data only.{% endblocktrans %}
    </div>
    {% endif %}

    {% if not user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast">
                <strong>{{ site.product_name|default:"KoNote2" }}</strong>
            </a></li>
        </ul>
        <ul>
            <li><a href="{% url 'auth_app:login' %}">{% trans "Sign In" %}</a></li>
        </ul>
    </nav>
    {% endif %}

    {% if user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast">
                <strong>{{ site.product_name|default:"KoNote2" }}</strong>
            </a></li>
            <li>
                <!-- Mobile menu toggle -->
                <button type="button" id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="{% trans 'Toggle navigation menu' %}">
                    <span class="nav-toggle-icon" aria-hidden="true"></span>
                </button>
            </li>
        </ul>
        <ul id="nav-menu">
            {% if not is_admin_only and not is_executive_only %}
            <li><a href="/"{% if nav_active == "clients" %} class="nav-active"{% endif %}>{{ term.client_plural|default:"Participants" }}</a></li>
            {% endif %}
            {% if is_executive_only %}
            <li><a href="{% url 'clients:executive_dashboard' %}"{% if nav_active == "executive" %} class="nav-active"{% endif %}>{% trans "Dashboard" %}</a></li>
            {% endif %}
            {% if features.programs %}
            <li><a href="/programs/"{% if nav_active == "programs" %} class="nav-active"{% endif %}>{{ term.program_plural|default:"Programs" }}</a></li>
            {% endif %}
            {% if has_program_roles and not is_receptionist_only %}
            <li><a href="/reports/insights/"{% if nav_active == "insights" %} class="nav-active"{% endif %}>{% trans "Insights" %}</a></li>
            {% endif %}
            {% if has_export_access %}
            <li><a href="/reports/export/"{% if nav_active == "reports" %} class="nav-active"{% endif %}>{% trans "Reports" %}</a></li>
            {% endif %}
            {% if features.groups and not is_executive_only and not is_receptionist_only %}
            <li><a href="/groups/"{% if nav_active == "groups" %} class="nav-active"{% endif %}>{{ term.group_plural|default:"Groups" }}</a></li>
            {% endif %}
            {% if user.is_admin %}
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "admin" %} class="nav-active"{% endif %}>{% trans "Admin" %}</summary>
                    <ul role="listbox">
                        <li><a href="/plans/admin/metrics/">{{ term.metric_plural|default:"Metrics" }}</a></li>
                        <li><a href="/admin/templates/">{% trans "Plan Templates" %}</a></li>
                        <li><a href="/admin/settings/note-templates/">{% trans "Note Templates" %}</a></li>
                        <li><a href="/events/admin/types/">{% trans "Event Types" %}</a></li>
                        <li><a href="/admin/registration/">{% trans "Registration Links" %}</a></li>
                        <li><a href="/admin/submissions/">{% trans "Pending Submissions" %}{% if pending_submissions_count %} <span class="badge badge-warning">{{ pending_submissions_count }}</span>{% endif %}</a></li>
                        <li><a href="/admin/settings/">{% trans "Settings" %}</a></li>
                        <li><a href="/auth/invites/">{% trans "Invites" %}</a></li>
                        <li><a href="/admin/audit/">{% trans "Audit Log" %}</a></li>
                        <li><a href="/merge/">{% trans "Merge Duplicates" %}</a></li>
                        <li><a href="/erasure/">{% blocktrans with term=term.client|default:"Participant" %}Erase {{ term }} Data{% endblocktrans %}{% if pending_erasure_count %} <span class="badge badge-warning">{{ pending_erasure_count }}</span>{% endif %}</a></li>
                        <li><a href="/reports/client-data-export/">{% blocktrans with term=term.client|default:"Participant" %}Export {{ term }} Data{% endblocktrans %}</a></li>
                    </ul>
                </details>
            </li>
            {% endif %}
            {% include "_program_switcher.html" %}
            <li class="nav-user-dropdown">
                <details class="dropdown" role="list" dir="rtl">
                    <summary aria-haspopup="listbox">{{ user.display_name }}{% if active_program_role_display %} <span class="badge badge-neutral nav-role-badge">{{ active_program_role_display }}</span>{% endif %}</summary>
                    <ul role="listbox">
                        <li><a href="{% url 'auth_app:logout' %}">{% trans "Sign Out" %}</a></li>
                    </ul>
                </details>
            </li>
            <li class="nav-user-mobile">
                <span class="nav-user-name">{{ user.display_name }}{% if active_program_role_display %} <span class="badge badge-neutral nav-role-badge">{{ active_program_role_display }}</span>{% endif %}</span>
            </li>
            <li class="nav-signout-mobile">
                <a href="{% url 'auth_app:logout' %}">{% trans "Sign Out" %}</a>
            </li>
            <li>
                <!-- Language link — canada.ca convention -->
                {% get_current_language as CURRENT_LANG %}
                <form action="{% url 'switch_language' %}" method="post" class="nav-lang-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    {% if CURRENT_LANG == "en" %}
                    <input type="hidden" name="language" value="fr">
                    <button type="submit" class="lang-link" lang="fr" hreflang="fr">Français</button>
                    {% else %}
                    <input type="hidden" name="language" value="en">
                    <button type="submit" class="lang-link" lang="en" hreflang="en">English</button>
                    {% endif %}
                </form>
            </li>
        </ul>
    </nav>
    {% endif %}

    <div id="offline-banner" class="offline-banner" hidden role="alert">
        {% trans "You appear to be offline. Your changes may not be saved." %}
        <button type="button" class="offline-retry">{% trans "Try again" %}</button>
    </div>

    <main id="main-content" class="container" tabindex="-1" aria-label="{% trans 'Main content' %}">
        {% if messages %}
        <div role="status" aria-live="polite" aria-atomic="false">
        {% for message in messages %}
        <article aria-label="notification" {% if message.tags %}class="{{ message.tags }}"{% endif %}>
            {{ message }}
        </article>
        {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- HTMX error toast — shown by app.js on network/server errors -->
    <div id="htmx-error-toast" class="toast toast-error" role="alert" hidden>
        <span id="htmx-error-toast-message"></span>
        <button type="button" id="htmx-error-toast-close" aria-label="{% trans 'Dismiss' %}" style="background:none;border:none;cursor:pointer;padding:0 0 0 1rem;font-size:1.2rem;color:inherit;">&times;</button>
    </div>

    <footer class="container site-footer" role="contentinfo">
        <div class="site-footer-inner">
            <div class="site-footer-brand">
                <strong>{{ site.product_name|default:"KoNote2" }}</strong>
                {% if site.support_email %}<span>{% trans "Support:" %} <a href="mailto:{{ site.support_email }}">{{ site.support_email }}</a></span>{% endif %}
            </div>
            <div class="site-footer-links">
                <a href="https://github.com/gilliankerr/KoNote-Redux" target="_blank" rel="noopener">GitHub</a>
                <a href="{% url 'privacy' %}">{% trans "Privacy" %}</a>
                <a href="{% url 'help' %}">{% trans "Help" %}</a>
                <button type="button" class="keyboard-shortcuts-btn" id="show-shortcuts" aria-label="{% trans 'Keyboard shortcuts' %}">?</button>
                {% get_current_language as FOOTER_LANG %}
                <form action="{% url 'switch_language' %}" method="post" class="footer-lang-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    {% if FOOTER_LANG == "en" %}
                    <input type="hidden" name="language" value="fr">
                    <button type="submit" class="lang-link" lang="fr" hreflang="fr">Français</button>
                    {% else %}
                    <input type="hidden" name="language" value="en">
                    <button type="submit" class="lang-link" lang="en" hreflang="en">English</button>
                    {% endif %}
                </form>
            </div>
            {% if user.is_authenticated %}
            <div class="site-footer-session">
                <span>{% trans "Logged in as" %} {{ user.display_name|default:user.username }}</span>
                <span class="session-timer" id="session-timer" data-timeout="{{ session_timeout_minutes|default:30 }}" data-warn="{% trans "Your login expires in {mins} minute(s)" %}" data-urgent="{% trans "You'll be logged out in {mins} minute(s)" %}" aria-live="polite" aria-atomic="true" hidden>
                    <span id="session-message"></span>
                </span>
                <button type="button" id="extend-session" class="extend-session-btn" hidden aria-label="{% trans 'Stay logged in' %}">{% trans "Stay logged in" %}</button>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- Keyboard shortcuts modal -->
    <div class="modal-backdrop" id="shortcuts-backdrop" hidden></div>
    <div class="keyboard-shortcuts-modal" id="shortcuts-modal" hidden role="dialog" aria-labelledby="shortcuts-title" aria-modal="true" tabindex="-1">
        <button type="button" class="modal-close" id="close-shortcuts" aria-label="{% trans 'Close' %}">&times;</button>
        <h2 id="shortcuts-title">{% trans "Keyboard Shortcuts" %}</h2>
        <dl>
            <dt>/</dt>
            <dd>{% trans "Focus search" %}</dd>
            <dt>g h</dt>
            <dd>{% trans "Go to Home" %}</dd>
            <dt>n</dt>
            <dd>{% blocktrans with client=term.client %}New quick note (on {{ client }} page){% endblocktrans %}</dd>
            <dt>Ctrl+S</dt>
            <dd>{% trans "Save current form" %}</dd>
            <dt>Esc</dt>
            <dd>{% trans "Close modal / Cancel" %}</dd>
            <dt>?</dt>
            <dd>{% trans "Show this help" %}</dd>
        </dl>
    </div>

    <!-- HTMX — dynamic interactions without a JS framework -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- Chart.js — for analysis charts (loaded globally for HTMX compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- Translated strings for app.js (I18N-4) -->
    <script>
    window.KN = {
        dismissMessage: "{% trans 'Dismiss message' %}",
        errorGeneric: "{% trans 'Something went wrong. Please try again.' %}",
        error403: "{% trans "You don't have permission to do that." %}",
        error404: "{% trans 'The requested item was not found.' %}",
        error500: "{% trans 'A server error occurred. Please try again later.' %}",
        errorNetwork: "{% trans 'Could not connect to the server. Check your internet connection.' %}",
        justNow: "{% trans 'just now' %}",
        oneMinuteAgo: "{% trans '1 minute ago' %}",
        minutesAgo: "{% trans '{n} minutes ago' %}",
        oneHourAgo: "{% trans '1 hour ago' %}",
        hoursAgo: "{% trans '{n} hours ago' %}",
        earlier: "{% trans 'earlier' %}",
        draftFound: "{% trans 'Draft found' %}",
        unsavedWork: "{% trans 'You have unsaved work from {time}.' %}",
        restoreDraft: "{% trans 'Restore draft' %}",
        discard: "{% trans 'Discard' %}",
        draftRestored: "{% trans 'Draft restored' %}",
        saving: "{% trans 'Saving…' %}",
        saved: "{% trans 'Saved' %}",
        unsavedWarning: "{% trans 'You have unsaved changes. Are you sure you want to leave?' %}"
    };
    </script>
    <!-- App JS — CSRF handling, error handlers -->
    <script src="{% static 'js/app.js' %}"></script>

    <!-- Service worker — shows offline page when navigation fails (BUG-6) -->
    <script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js", { scope: "/" })
            .catch(function() { /* Service worker not critical */ });
    }
    </script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
