{% load i18n %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ site.product_name|default:"KoNote2" }}{% endblock %}</title>

    <!-- Pico CSS — classless, accessible defaults -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

    {% load static %}
    <!-- Theme (brand identity — swappable per agency) -->
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">

    <!-- App structure styles -->
    <link rel="stylesheet" href="{% static 'css/main.css' %}">

    {% block extra_head %}{% endblock %}
</head>
<body>
    <a href="#main-content" class="visually-hidden-focusable">{% trans "Skip to main content" %}</a>

    <!-- Loading bar — shown during HTMX requests -->
    <div id="loading-bar" class="loading-bar htmx-indicator"></div>

    {% if user.is_authenticated and user.is_demo %}
    <div class="demo-banner" role="alert" aria-live="polite">
        <strong>{% trans "Demo Mode:" %}</strong> {% blocktrans with name=user.display_name %}You are logged in as {{ name }}. Changes affect demo data only.{% endblocktrans %}
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <nav class="container-fluid">
        <ul>
            <li><a href="/" class="contrast">
                <strong>{{ site.product_name|default:"KoNote2" }}</strong>
            </a></li>
            <li>
                <!-- Mobile menu toggle -->
                <button type="button" id="nav-toggle" class="nav-toggle" aria-expanded="false" aria-controls="nav-menu" aria-label="{% trans 'Toggle navigation menu' %}">
                    <span class="nav-toggle-icon" aria-hidden="true"></span>
                </button>
            </li>
        </ul>
        <ul id="nav-menu">
            {% if not is_admin_only and not is_executive_only %}
            <li><a href="/"{% if nav_active == "clients" %} class="nav-active"{% endif %}>{{ term.client_plural|default:"Clients" }}</a></li>
            {% endif %}
            {% if is_executive_only %}
            <li><a href="{% url 'clients:executive_dashboard' %}"{% if nav_active == "executive" %} class="nav-active"{% endif %}>{% trans "Dashboard" %}</a></li>
            {% endif %}
            {% if features.programs %}
            <li><a href="/programs/"{% if nav_active == "programs" %} class="nav-active"{% endif %}>{{ term.program_plural|default:"Programs" }}</a></li>
            {% endif %}
            {% if has_export_access %}
            <li><a href="/reports/export/"{% if nav_active == "reports" %} class="nav-active"{% endif %}>{% trans "Reports" %}</a></li>
            {% endif %}
            {% if user.is_admin %}
            <li>
                <details class="dropdown" role="list">
                    <summary aria-haspopup="listbox"{% if nav_active == "admin" %} class="nav-active"{% endif %}>{% trans "Admin" %}</summary>
                    <ul role="listbox">
                        <li><a href="/plans/admin/metrics/">{{ term.metric_plural|default:"Metrics" }}</a></li>
                        <li><a href="/admin/templates/">{% trans "Plan Templates" %}</a></li>
                        <li><a href="/admin/settings/note-templates/">{% trans "Note Templates" %}</a></li>
                        <li><a href="/events/admin/types/">{% trans "Event Types" %}</a></li>
                        <li><a href="/admin/registration/">{% trans "Registration Links" %}</a></li>
                        <li><a href="/admin/submissions/">{% trans "Pending Submissions" %}{% if pending_submissions_count %} <span class="badge badge-warning">{{ pending_submissions_count }}</span>{% endif %}</a></li>
                        <li><a href="/admin/settings/">{% trans "Settings" %}</a></li>
                        <li><a href="/auth/invites/">{% trans "Invites" %}</a></li>
                        <li><a href="/admin/audit/">{% trans "Audit Log" %}</a></li>
                        <li><a href="/erasure/">{% trans "Erase Client Data" %}{% if pending_erasure_count %} <span class="badge badge-warning">{{ pending_erasure_count }}</span>{% endif %}</a></li>
                        <li><a href="/reports/client-data-export/">{% trans "Export Client Data" %}</a></li>
                    </ul>
                </details>
            </li>
            {% endif %}
            <li>
                <details class="dropdown" role="list" dir="rtl">
                    <summary aria-haspopup="listbox">{{ user.display_name }}</summary>
                    <ul role="listbox">
                        <li><a href="/auth/logout/">{% trans "Sign Out" %}</a></li>
                    </ul>
                </details>
            </li>
            <li>
                <!-- Language link — canada.ca convention -->
                {% get_current_language as CURRENT_LANG %}
                <form action="{% url 'switch_language' %}" method="post" class="nav-lang-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    {% if CURRENT_LANG == "en" %}
                    <input type="hidden" name="language" value="fr">
                    <button type="submit" class="lang-link" lang="fr" hreflang="fr">Français</button>
                    {% else %}
                    <input type="hidden" name="language" value="en">
                    <button type="submit" class="lang-link" lang="en" hreflang="en">English</button>
                    {% endif %}
                </form>
            </li>
        </ul>
    </nav>
    {% endif %}

    <main id="main-content" class="container">
        {% if messages %}
        {% for message in messages %}
        <article aria-label="notification" {% if message.tags %}class="{{ message.tags }}"{% endif %}>
            {{ message }}
        </article>
        {% endfor %}
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- HTMX error toast — shown by app.js on network/server errors -->
    <div id="htmx-error-toast" class="toast toast-error" role="alert" hidden>
        <span id="htmx-error-toast-message"></span>
        <button type="button" id="htmx-error-toast-close" aria-label="{% trans 'Dismiss' %}" style="background:none;border:none;cursor:pointer;padding:0 0 0 1rem;font-size:1.2rem;color:inherit;">&times;</button>
    </div>

    <footer class="container site-footer" role="contentinfo">
        <div class="site-footer-inner">
            <div class="site-footer-brand">
                <strong>{{ site.product_name|default:"KoNote2" }}</strong>
                {% if site.support_email %}<span>{% trans "Support:" %} <a href="mailto:{{ site.support_email }}">{{ site.support_email }}</a></span>{% endif %}
            </div>
            <div class="site-footer-links">
                <a href="https://github.com/KoNote2/konote2" target="_blank" rel="noopener">GitHub</a>
                <a href="/privacy/">{% trans "Privacy" %}</a>
                <a href="/help/">{% trans "Help" %}</a>
                <button type="button" class="keyboard-shortcuts-btn" id="show-shortcuts" aria-label="{% trans 'Keyboard shortcuts' %}">?</button>
            </div>
            {% if user.is_authenticated %}
            <div class="site-footer-session">
                <span>{% trans "Logged in as" %} {{ user.display_name|default:user.username }}</span>
                <span class="session-timer" id="session-timer" data-timeout="{{ session_timeout_minutes|default:30 }}">
                    {% trans "Session:" %} <span id="session-remaining">--</span> {% trans "min" %}
                </span>
            </div>
            {% endif %}
        </div>
    </footer>

    <!-- Keyboard shortcuts modal -->
    <div class="modal-backdrop" id="shortcuts-backdrop" hidden></div>
    <div class="keyboard-shortcuts-modal" id="shortcuts-modal" hidden role="dialog" aria-labelledby="shortcuts-title" aria-modal="true">
        <button type="button" class="modal-close" id="close-shortcuts" aria-label="{% trans 'Close' %}">&times;</button>
        <h3 id="shortcuts-title">{% trans "Keyboard Shortcuts" %}</h3>
        <dl>
            <dt>/</dt>
            <dd>{% trans "Focus search" %}</dd>
            <dt>g h</dt>
            <dd>{% trans "Go to Home" %}</dd>
            <dt>n</dt>
            <dd>{% trans "New quick note (on client page)" %}</dd>
            <dt>Ctrl+S</dt>
            <dd>{% trans "Save current form" %}</dd>
            <dt>Esc</dt>
            <dd>{% trans "Close modal / Cancel" %}</dd>
            <dt>?</dt>
            <dd>{% trans "Show this help" %}</dd>
        </dl>
    </div>

    <!-- HTMX — dynamic interactions without a JS framework -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- Chart.js — for analysis charts (loaded globally for HTMX compatibility) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <!-- App JS — CSRF handling, error handlers -->
    <script src="{% static 'js/app.js' %}"></script>

    {% block extra_scripts %}{% endblock %}
</body>
</html>
