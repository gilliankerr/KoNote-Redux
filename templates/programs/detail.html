{% extends "base.html" %}
{% load i18n %}

{% block title %}{{ program.translated_name }} — {{ site.product_name|default:"KoNote2" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>
        <span class="program-dot" style="background-color: {{ program.colour_hex }}" aria-hidden="true"></span>
        {{ program.translated_name }}
    </h1>
    <p>{{ program.description }}</p>
</hgroup>

<p>
    <small>
        {% if program.service_model == "individual" %}
            {% trans "One-on-one — individual notes and plans" %}
        {% elif program.service_model == "group" %}
            {% trans "Group sessions — attendance and session notes" %}
        {% else %}
            {% trans "Both — individual notes and group sessions" %}
        {% endif %}
        {% if program.is_confidential %}
            &middot; <strong>{% trans "Confidential" %}</strong>
        {% endif %}
    </small>
</p>

<div role="group">
    {% if is_admin %}
    <a href="{% url 'programs:program_edit' program_id=program.pk %}" role="button" class="outline">{% blocktrans with program=term.program|default:"Program" %}Edit {{ program }}{% endblocktrans %}</a>
    {% endif %}
    <a href="{% url 'programs:program_list' %}" class="back-link">&larr; {% trans "Back to List" %}</a>
</div>

<hr>

{% if program_summary %}
<section aria-labelledby="program-health-heading">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--kn-space-base);">
        <h2 id="program-health-heading" style="margin-bottom: 0;">{% trans "Program Health" %}</h2>
        <small class="secondary">{% trans "Last 6 months" %}</small>
    </header>

    {% if program_summary.note_count > 0 %}
    <div class="stats-row">
        <dl class="stat-card">
            <dt>{% trans "Active" %} {{ term.client_plural|default:"Participants" }}</dt>
            <dd class="stat-value">{{ program_summary.participant_count }}</dd>
            <dd class="stat-subtext">{% trans "with notes recorded" %}</dd>
        </dl>

        <dl class="stat-card">
            <dt>{% trans "Progress Notes" %}</dt>
            <dd class="stat-value">{{ program_summary.note_count }}</dd>
            <dd class="stat-subtext">{% trans "last 6 months" %}</dd>
        </dl>

        {% if program_summary.top_descriptor %}
        <dl class="stat-card">
            <dt>{% trans "Top Outcome" %}</dt>
            <dd class="stat-value">{{ program_summary.top_descriptor.percentage }}%</dd>
            <dd class="stat-subtext">{{ program_summary.top_descriptor.label }}</dd>
        </dl>
        {% endif %}
    </div>

    <div role="group">
        <a href="{% url 'reports:program_insights' %}?program={{ program.pk }}&time_period=6m"
           role="button" class="outline">{% trans "View Program Results" %} &rarr;</a>
        {% if has_export_access %}
        <a href="{% url 'reports:export_form' %}"
           role="button" class="outline secondary">{% trans "Export Program Data" %} &rarr;</a>
        {% endif %}
    </div>
    {% else %}
    <p><em>{% trans "No notes recorded yet for this program in the last 6 months." %}</em></p>
    {% endif %}
</section>

<hr>
{% endif %}

<h2>{% trans "Assigned Staff" %}</h2>

{% if is_admin %}
<form hx-post="{% url 'programs:program_add_role' program_id=program.pk %}"
      hx-target="#role-list"
      hx-swap="innerHTML">
    {% csrf_token %}
    <fieldset role="group">
        <select name="user" aria-label="{% trans 'Select user' %}" required>
            <option value="">{% trans "Choose a user..." %}</option>
            {% for option in role_form.user.field.queryset %}
            <option value="{{ option.pk }}">{{ option.display_name }}</option>
            {% endfor %}
        </select>
        <select name="role" aria-label="{% trans 'Select role' %}" required>
            {% for value, label in role_form.role.field.choices %}
            <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <button type="submit">{% trans "Add" %}</button>
    </fieldset>
</form>
{% endif %}

<div id="role-list" aria-live="polite">
    {% include "programs/_role_list.html" %}
</div>

{% if groups != None %}
<hr>
<section aria-labelledby="groups-heading">
    <h2 id="groups-heading">{% trans "Groups" %}</h2>

    {% if is_receptionist %}
    {# Front Desk: summary only — group names can reveal clinical info #}
    {% if group_count %}
    <p>
        {% blocktrans count count=group_count %}{{ count }} active group{% plural %}{{ count }} active groups{% endblocktrans %}
        {% if program_manager_name %}
        — {% blocktrans with name=program_manager_name %}for group inquiries, contact <strong>{{ name }}</strong>{% endblocktrans %}
        {% endif %}
    </p>
    {% else %}
    <p><em>{% trans "No groups created yet." %}</em></p>
    {% endif %}
    {% else %}

    {% if groups %}
    <figure>
    <table role="grid" aria-label="{% trans 'Groups in this program' %}">
        <thead>
            <tr>
                <th scope="col">{% trans "Name" %}</th>
                <th scope="col">{% trans "Members" %}</th>
                {% if not is_executive_only %}<th scope="col">{% trans "Actions" %}</th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for group in groups %}
            <tr>
                <td>{% if is_executive_only %}{{ group.name }}{% else %}<a href="{% url 'groups:group_detail' group_id=group.pk %}">{{ group.name }}</a>{% endif %}</td>
                <td data-label="{% trans 'Members' %}">{{ group.member_count }}</td>
                {% if not is_executive_only %}
                <td data-label="{% trans 'Actions' %}">
                    <a href="{% url 'groups:session_log' group_id=group.pk %}" role="button" class="outline small">{% trans "Log Session" %}</a>
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    </figure>
    {% else %}
    <p><em>{% trans "No groups created yet." %}</em></p>
    {% endif %}

    {% if not is_executive_only %}
    <a href="{% url 'groups:group_create' %}" role="button" class="outline">{% trans "Create Group" %}</a>
    {% endif %}
    {% endif %}
</section>
{% endif %}
{% endblock %}
