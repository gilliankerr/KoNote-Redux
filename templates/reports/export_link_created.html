{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Your Report Is Ready" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Your Report Is Ready" %}</h1>
    {% if program_name %}
    <p>{{ program_name }} — {{ link.get_export_type_display }}</p>
    {% endif %}
</hgroup>

{% if link.is_elevated and not link.is_available %}
{# ── Elevated export: delay still active ── #}
<article aria-label="{% trans 'Download pending' %}" style="border-left: 4px solid var(--pico-color-yellow-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x23F3;</span> {% trans "Download available shortly" %}</strong>
    <p>
        {% blocktrans with time=link.available_at|date:"H:i" strong_open="<strong>" strong_close="</strong>" %}Because this export contains sensitive data, there is a short security delay. Your download will be available at {{ strong_open }}{{ time }}{{ strong_close }}.{% endblocktrans %}
    </p>
    <p style="margin-bottom: 0;">
        {% trans "You can bookmark this page and return, or wait a few minutes and click the button below." %}
    </p>
</article>

<a href="{{ download_path }}" role="button" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; padding: 0.75rem 2rem;">
    <span aria-hidden="true">&#x2B07;</span> {% trans "Download" %}
</a>

{% else %}
{# ── Normal export: ready for immediate download ── #}
<article aria-label="{% trans 'Success' %}" style="border-left: 4px solid var(--pico-color-green-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x2705;</span> {% trans "Report generated successfully" %}</strong>
    <p style="margin-bottom: 0;">
        {% if is_pdf %}
        {% trans "Your PDF report is ready to download." %}
        {% else %}
        {% trans "Your CSV file is ready to download. You can open it in Excel or Google Sheets." %}
        {% endif %}
    </p>
</article>

{# Primary action: big download button #}
<a href="{{ download_path }}" role="button" id="download-btn" style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; padding: 0.75rem 2rem; margin-bottom: 0.5rem;">
    {% if is_pdf %}
    <span aria-hidden="true">&#x1F4C4;</span> {% trans "Download PDF Report" %}
    {% else %}
    <span aria-hidden="true">&#x1F4CA;</span> {% trans "Download CSV File" %}
    {% endif %}
</a>
<p style="color: var(--pico-muted-color); font-size: 0.9rem; margin-bottom: 1.5rem;">
    {% trans "Your file will appear in your browser's Downloads folder." %}
</p>
{% endif %}

{# Expiry notice — small, not alarming #}
<p style="color: var(--pico-muted-color); font-size: 0.9rem; margin-bottom: 2rem;">
    {% blocktrans with expires=link.expires_at|date:"M j, H:i" %}This download link expires {{ expires }}. You can return to this page and download again until then.{% endblocktrans %}
</p>

{# Secondary action: share link (collapsed by default) #}
<details style="margin-bottom: 1.5rem;">
    <summary style="cursor: pointer;">
        <span aria-hidden="true">&#x1F517;</span> {% trans "Need to share this report with a colleague?" %}
    </summary>
    <div style="margin-top: 1rem;">
        <p>{% trans "Copy this link to share the download with someone else in your organisation. All downloads are logged for audit purposes." %}</p>
        <div class="grid" style="align-items: center;">
            <input
                type="text"
                id="export-link"
                value="{{ download_url }}"
                readonly
                aria-label="{% trans 'Shareable download URL' %}"
                style="font-family: monospace; font-size: 0.85rem;"
            >
            <button
                type="button"
                id="copy-link-btn"
                onclick="copyExportLink()"
                style="max-width: 10rem;"
                class="secondary"
            >
                <span aria-hidden="true">&#x1F4CB;</span> {% trans "Copy Link" %}
            </button>
        </div>
        <small id="copy-feedback" aria-live="polite" style="display: none; color: var(--pico-color-green-500);">
            {% trans "Link copied to clipboard." %}
        </small>
    </div>
</details>

{# Export details (collapsed — only for people who want specifics) #}
<details style="margin-bottom: 1.5rem;">
    <summary style="cursor: pointer; color: var(--pico-muted-color);">
        <span aria-hidden="true">&#x1F4CB;</span> {% trans "Export details" %}
    </summary>
    <table role="grid" style="margin-top: 1rem;">
        <tbody>
            <tr>
                <th scope="row">{% trans "Export type" %}</th>
                <td>{{ link.get_export_type_display }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "Participants" %}</th>
                <td>{{ link.client_count }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "Recipient" %}</th>
                <td>{{ link.recipient }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "File" %}</th>
                <td>{{ link.filename }}</td>
            </tr>
        </tbody>
    </table>
</details>

<a href="{% url 'reports:export_form' %}" role="button" class="secondary outline" style="margin-top: 1rem;">
    <span aria-hidden="true">&larr;</span> {% trans "Generate Another Report" %}
</a>

<script>
/**
 * Copy the secure download link to the clipboard.
 * Falls back to legacy execCommand for older browsers.
 */
function copyExportLink() {
    var linkInput = document.getElementById('export-link');
    var feedback = document.getElementById('copy-feedback');
    var btn = document.getElementById('copy-link-btn');

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(linkInput.value).then(function() {
            showCopyFeedback(feedback, btn);
        }, function() {
            fallbackCopy(linkInput, feedback, btn);
        });
    } else {
        fallbackCopy(linkInput, feedback, btn);
    }
}

/**
 * Fallback copy method using select + execCommand.
 */
function fallbackCopy(input, feedback, btn) {
    input.select();
    input.setSelectionRange(0, 99999);
    try {
        document.execCommand('copy');
        showCopyFeedback(feedback, btn);
    } catch (err) {
        // If copy fails, the text is already selected so the user can copy manually
    }
}

/**
 * Show a brief "copied" confirmation message.
 */
function showCopyFeedback(feedback, btn) {
    feedback.style.display = 'block';
    btn.textContent = '\u2714 ' + '{% trans "Copied!" %}';
    setTimeout(function() {
        feedback.style.display = 'none';
        btn.innerHTML = '<span aria-hidden="true">&#x1F4CB;</span> ' + '{% trans "Copy Link" %}';
    }, 3000);
}
</script>
{% endblock %}
