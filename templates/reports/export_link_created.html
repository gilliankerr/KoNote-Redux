{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Export Link Created" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Export Link Created" %}</h1>
    <p>{% trans "Your secure download link is ready." %}</p>
</hgroup>

{# Success confirmation #}
<article aria-label="{% trans 'Success' %}" style="border-left: 4px solid var(--pico-color-green-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x2705;</span> {% trans "Export created successfully" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with expires=link.expires_at strong_open="<strong>" strong_close="</strong>" %}The download link below is active and will expire on {{ strong_open }}{{ expires }}{{ strong_close }}.{% endblocktrans %}
    </p>
</article>

{% if link.is_elevated %}
{# Elevated export delay warning #}
<article aria-label="{% trans 'Elevated export notice' %}" style="border-left: 4px solid var(--pico-color-yellow-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x23F3;</span> {% trans "Elevated Export — Delay Applied" %}</strong>
    <p>
        {% blocktrans with time=link.available_at|date:"H:i" strong_open="<strong>" strong_close="</strong>" %}This export contains a large number of clients or clinical notes. For security, the download link will not become active until {{ strong_open }}{{ time }}{{ strong_close }}. Administrators have been notified.{% endblocktrans %}
    </p>
    <p style="margin-bottom: 0;">
        {% trans "You can share the link now — the recipient will be able to download after the delay period." %}
    </p>
</article>
{% endif %}

{# Export details #}
<article aria-label="{% trans 'Export details' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F4CB;</span> {% trans "Export Details" %}</strong>
    <table role="grid">
        <tbody>
            <tr>
                <th scope="row">{% trans "Export type" %}</th>
                <td>{{ link.get_export_type_display }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "Client count" %}</th>
                <td>{{ link.client_count }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "Recipient" %}</th>
                <td>{{ link.recipient }}</td>
            </tr>
            <tr>
                <th scope="row">{% trans "Expires" %}</th>
                <td>{{ link.expires_at }}</td>
            </tr>
        </tbody>
    </table>
</article>

{# Secure download link with copy button #}
<article aria-label="{% trans 'Download link' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F517;</span> {% trans "Secure Download Link" %}</strong>
    <p>
        {% trans "Copy this link and share it with the intended recipient." %}
    </p>
    <div class="grid" style="align-items: center;">
        <input
            type="text"
            id="export-link"
            value="{{ download_url }}"
            readonly
            aria-label="{% trans 'Secure download URL' %}"
            style="font-family: monospace; font-size: 0.9rem;"
        >
        <button
            type="button"
            id="copy-link-btn"
            onclick="copyExportLink()"
            style="max-width: 10rem;"
        >
            <span aria-hidden="true">&#x1F4CB;</span> {% trans "Copy Link" %}
        </button>
    </div>
    <small id="copy-feedback" aria-live="polite" style="display: none; color: var(--pico-color-green-500);">
        {% trans "Link copied to clipboard." %}
    </small>
</article>

{# Audit notice #}
<article aria-label="{% trans 'Audit notice' %}" style="border-left: 4px solid var(--pico-color-yellow-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">&#x1F6C8;</span> {% trans "Sharing Notice" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with strong_open="<strong>" strong_close="</strong>" %}This link can be shared with others in your organisation. All downloads are {{ strong_open }}logged for audit purposes{{ strong_close }}, including the time of access and the identity of the person downloading. Handle the exported data according to your organisation's data protection policies.{% endblocktrans %}
    </p>
</article>

<a href="{% url 'reports:export_form' %}" role="button" class="secondary">
    <span aria-hidden="true">&larr;</span> {% trans "Back to Reports" %}
</a>

<script>
/**
 * Copy the secure download link to the clipboard.
 * Falls back to legacy execCommand for older browsers.
 */
function copyExportLink() {
    var linkInput = document.getElementById('export-link');
    var feedback = document.getElementById('copy-feedback');
    var btn = document.getElementById('copy-link-btn');

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(linkInput.value).then(function() {
            showCopyFeedback(feedback, btn);
        }, function() {
            fallbackCopy(linkInput, feedback, btn);
        });
    } else {
        fallbackCopy(linkInput, feedback, btn);
    }
}

/**
 * Fallback copy method using select + execCommand.
 */
function fallbackCopy(input, feedback, btn) {
    input.select();
    input.setSelectionRange(0, 99999);
    try {
        document.execCommand('copy');
        showCopyFeedback(feedback, btn);
    } catch (err) {
        // If copy fails, the text is already selected so the user can copy manually
    }
}

/**
 * Show a brief "copied" confirmation message.
 */
function showCopyFeedback(feedback, btn) {
    feedback.style.display = 'block';
    btn.textContent = '\u2714 ' + '{% trans "Copied!" %}';
    setTimeout(function() {
        feedback.style.display = 'none';
        btn.innerHTML = '<span aria-hidden="true">&#x1F4CB;</span> ' + '{% trans "Copy Link" %}';
    }, 3000);
}
</script>
{% endblock %}
