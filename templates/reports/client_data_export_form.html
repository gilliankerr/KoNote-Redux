{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Client Data Export" %} ‚Äî {{ site.product_name|default:"KoNote2" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Client Data Export" %}</h1>
    <p>{% trans "Export all client data as a CSV file for data portability, backup, or migration to another system." %}</p>
</hgroup>

{% if no_data %}
<article aria-label="{% trans 'No results' %}">
    <p><strong>{% trans "No data found." %}</strong> {% trans "There are no clients matching the selected filters. Try adjusting your filters or leave them blank to export all clients." %}</p>
</article>
{% endif %}

{% if total_client_count %}
<article aria-label="{% trans 'Client Count' %}" style="margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">üìã</span> {% trans "Export Preview" %}</strong>
    <p style="margin-bottom: 0;">
        {% blocktrans with strong_open="<strong>" strong_close="</strong>" count count=total_client_count %}You have access to {{ strong_open }}{{ count }}{{ strong_close }} client record.{% plural %}You have access to {{ strong_open }}{{ count }}{{ strong_close }} client records.{% endblocktrans %}
        {% trans "Use the filters below to narrow down the export." %}
    </p>
</article>
{% endif %}

<article class="pico-background-yellow-50" aria-label="{% trans 'PII Warning' %}" role="alert" style="border-left: 4px solid var(--pico-color-yellow-500); padding: 1rem; margin-bottom: 1.5rem;">
    <strong><span aria-hidden="true">‚ö†Ô∏è</span> {% trans "This export includes personal information" %}</strong>
    <p style="margin-bottom: 0.5rem;">
        {% trans "The exported file will contain:" %}
    </p>
    <ul style="margin-bottom: 0.5rem;">
        <li><strong>{% trans "Names" %}</strong> ({% trans "first, middle, last" %})</li>
        <li><strong>{% trans "Birth dates" %}</strong></li>
        <li><strong>{% trans "Status and dates" %}</strong> ({% trans "created, updated" %})</li>
        <li><strong>{% trans "Consent information" %}</strong> ({% trans "if selected" %})</li>
        <li><strong>{% trans "Programme enrolments" %}</strong> ({% trans "if selected" %})</li>
        <li><strong>{% trans "Custom field values" %}</strong> ({% trans "if selected" %})</li>
    </ul>
    <p style="margin-bottom: 0;">
        {% trans "Handle the exported file according to your organisation's data protection policies." %}
    </p>
</article>

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <article class="pico-background-red-100" aria-label="{% trans 'Form errors' %}" role="alert">
        {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </article>
    {% endif %}

    {# Programme filter (optional) #}
    <label for="{{ form.program.id_for_label }}">
        {{ form.program.label }}
        {{ form.program }}
        {% if form.program.help_text %}
        <small>{{ form.program.help_text }}</small>
        {% endif %}
    </label>
    {% if form.program.errors %}
    <small class="error" role="alert">{{ form.program.errors.0 }}</small>
    {% endif %}

    {# Status filter (optional) #}
    <label for="{{ form.status.id_for_label }}">
        {{ form.status.label }}
        {{ form.status }}
        {% if form.status.help_text %}
        <small>{{ form.status.help_text }}</small>
        {% endif %}
    </label>
    {% if form.status.errors %}
    <small class="error" role="alert">{{ form.status.errors.0 }}</small>
    {% endif %}

    {# Export options #}
    <fieldset>
        <legend>{% trans "Include in export" %}</legend>

        <label>
            {{ form.include_custom_fields }}
            {{ form.include_custom_fields.label }}
            {% if form.include_custom_fields.help_text %}
            <small>{{ form.include_custom_fields.help_text }}</small>
            {% endif %}
        </label>

        <label>
            {{ form.include_enrolments }}
            {{ form.include_enrolments.label }}
            {% if form.include_enrolments.help_text %}
            <small>{{ form.include_enrolments.help_text }}</small>
            {% endif %}
        </label>

        <label>
            {{ form.include_consent }}
            {{ form.include_consent.label }}
            {% if form.include_consent.help_text %}
            <small>{{ form.include_consent.help_text }}</small>
            {% endif %}
        </label>
    </fieldset>

    {# Recipient tracking for audit purposes #}
    <fieldset>
        <legend>{% trans "Export Recipient" %}</legend>
        <p class="helper-text" style="margin-bottom: 1rem; color: var(--pico-muted-color);">
            {% trans "For audit purposes, please indicate who will receive this exported data." %}
        </p>
        <label for="{{ form.recipient.id_for_label }}">
            {{ form.recipient.label }}
            {{ form.recipient }}
            {% if form.recipient.help_text %}
            <small>{{ form.recipient.help_text }}</small>
            {% endif %}
            {% if form.recipient.errors %}
            <small class="error" role="alert">{{ form.recipient.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.recipient_detail.id_for_label }}" id="recipient-detail-wrapper">
            {{ form.recipient_detail.label }}
            {{ form.recipient_detail }}
            {% if form.recipient_detail.help_text %}
            <small>{{ form.recipient_detail.help_text }}</small>
            {% endif %}
            {% if form.recipient_detail.errors %}
            <small class="error" role="alert">{{ form.recipient_detail.errors.0 }}</small>
            {% endif %}
        </label>
    </fieldset>

    <button type="submit">{% trans "Export Client Data" %}</button>
</form>
{% endblock %}
