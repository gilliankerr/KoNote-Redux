{% load i18n %}
<!-- Partial: Analysis tab content -->
<div role="group" style="margin-bottom: 1rem;">
    <a href="{% url 'reports:client_progress_pdf' client_id=client.pk %}" role="button" class="outline">{% trans "Export as PDF" %}</a>
</div>

{% if chart_data %}
    {% for chart in chart_data %}
    <section>
        <h3>{{ chart.target_name }} â€” {{ chart.metric_name }}</h3>
        <div class="chart-container" style="position: relative; height: 300px;">
            <canvas id="chart-{{ forloop.counter }}" aria-label="{% blocktrans with metric=chart.metric_name target=chart.target_name %}Line chart showing {{ metric }} over time for {{ target }}{% endblocktrans %}" role="img"></canvas>
        </div>
    </section>
    {% endfor %}

{{ chart_data_json|json_script:"chart-data" }}
<script>
console.log('[Chart Debug] Script is executing');
console.log('[Chart Debug] Chart global:', typeof Chart);
const chartDataEl = document.getElementById('chart-data');
console.log('[Chart Debug] chart-data element:', chartDataEl);
const chartData = JSON.parse(chartDataEl.textContent);
console.log('[Chart Debug] Parsed chart data:', chartData);
chartData.forEach(function(chart, index) {
    console.log('[Chart Debug] Processing chart', index + 1, ':', chart.target_name);
    const ctx = document.getElementById('chart-' + (index + 1)).getContext('2d');
    const datasets = [{
        label: chart.metric_name + (chart.unit ? ' (' + chart.unit + ')' : ''),
        data: chart.data_points.map(function(p) { return p.value; }),
        borderColor: 'rgb(59, 130, 246)',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        fill: true,
        tension: 0.3,
    }];
    if (chart.min_value !== null) {
        datasets.push({
            label: '{% trans "Minimum" %}' + ' (' + chart.min_value + ')',
            data: Array(chart.data_points.length).fill(chart.min_value),
            borderColor: 'rgba(239, 68, 68, 0.5)',
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
        });
    }
    if (chart.max_value !== null) {
        datasets.push({
            label: '{% trans "Maximum" %}' + ' (' + chart.max_value + ')',
            data: Array(chart.data_points.length).fill(chart.max_value),
            borderColor: 'rgba(34, 197, 94, 0.5)',
            borderDash: [5, 5],
            pointRadius: 0,
            fill: false,
        });
    }
    const canvasEl = document.getElementById('chart-' + (index + 1));
    console.log('[Chart Debug] Canvas element:', canvasEl);
    if (!canvasEl) {
        console.error('[Chart Debug] Canvas not found for chart', index + 1);
        return;
    }
    try {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: chart.data_points.map(function(p) { return p.date; }),
                datasets: datasets,
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                scales: {
                    y: { beginAtZero: false, title: { display: true, text: chart.unit || '{% trans "Value" %}' } },
                    x: { title: { display: true, text: '{% trans "Date" %}' } },
                },
            },
        });
        console.log('[Chart Debug] Chart', index + 1, 'created successfully');
    } catch (err) {
        console.error('[Chart Debug] Error creating chart', index + 1, ':', err);
    }
});
</script>
{% else %}
    <p class="empty-state">{% trans "No metric data recorded yet. Record metrics through progress notes to see charts here." %}</p>
{% endif %}
