{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Funder Report Export" %} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% trans "Funder Report Export" %}</h1>
    <p>{% trans "Generate a report of aggregate metric data for a programme and date range." %}</p>
</hgroup>

{% if no_data %}
<article aria-label="{% trans 'No results' %}">
    <p><strong>{% trans "No data found." %}</strong> {% trans "There are no metric values matching the selected programme, metrics, and date range. Try adjusting your filters." %}</p>
</article>
{% endif %}

<form method="post">
    {% csrf_token %}

    {% if form.non_field_errors %}
    <article class="pico-background-red-100" aria-label="{% trans 'Form errors' %}" role="alert">
        {% for error in form.non_field_errors %}
        <p>{{ error }}</p>
        {% endfor %}
    </article>
    {% endif %}

    {# Programme dropdown #}
    <label for="{{ form.program.id_for_label }}">
        {{ form.program.label }}
        {{ form.program }}
    </label>
    {% if form.program.errors %}
    <small class="error" role="alert">{{ form.program.errors.0 }}</small>
    {% endif %}

    {# Fiscal year quick-select #}
    <label for="{{ form.fiscal_year.id_for_label }}">
        {{ form.fiscal_year.label }}
        {{ form.fiscal_year }}
        {% if form.fiscal_year.help_text %}
        <small>{{ form.fiscal_year.help_text }}</small>
        {% endif %}
        {% if form.fiscal_year.errors %}
        <small class="error" role="alert">{{ form.fiscal_year.errors.0 }}</small>
        {% endif %}
    </label>

    {# Date range #}
    <div class="grid">
        <label for="{{ form.date_from.id_for_label }}">
            {{ form.date_from.label }}
            {{ form.date_from }}
            {% if form.date_from.errors %}
            <small class="error" role="alert">{{ form.date_from.errors.0 }}</small>
            {% endif %}
        </label>
        <label for="{{ form.date_to.id_for_label }}">
            {{ form.date_to.label }}
            {{ form.date_to }}
            {% if form.date_to.errors %}
            <small class="error" role="alert">{{ form.date_to.errors.0 }}</small>
            {% endif %}
        </label>
    </div>

    {# Demographic grouping #}
    <label for="{{ form.group_by.id_for_label }}">
        {{ form.group_by.label }}
        {{ form.group_by }}
        {% if form.group_by.help_text %}
        <small>{{ form.group_by.help_text }}</small>
        {% endif %}
        {% if form.group_by.errors %}
        <small class="error" role="alert">{{ form.group_by.errors.0 }}</small>
        {% endif %}
    </label>

    {# Export format #}
    <fieldset>
        <legend>{{ form.format.label }}</legend>
        {% for radio in form.format %}
        <label>
            {{ radio.tag }}
            {{ radio.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# Metric checkboxes #}
    <fieldset>
        <legend>{{ form.metrics.label }}</legend>
        {% if form.metrics.errors %}
        <small class="error" role="alert">{{ form.metrics.errors.0 }}</small>
        {% endif %}
        <div style="margin-bottom: 0.5rem;">
            <a href="#" id="select-all-metrics" class="secondary">{% trans "Select all" %}</a>
            &nbsp;|&nbsp;
            <a href="#" id="deselect-all-metrics" class="secondary">{% trans "Deselect all" %}</a>
        </div>
        {% for checkbox in form.metrics %}
        <label>
            {{ checkbox.tag }}
            {{ checkbox.choice_label }}
        </label>
        {% endfor %}
    </fieldset>

    {# Achievement rate option #}
    <fieldset>
        <legend>{% trans "Additional Options" %}</legend>
        <label>
            {{ form.include_achievement_rate }}
            {{ form.include_achievement_rate.label }}
            {% if form.include_achievement_rate.help_text %}
            <small>{{ form.include_achievement_rate.help_text }}</small>
            {% endif %}
        </label>
    </fieldset>

    <button type="submit">{% trans "Generate Report" %}</button>
</form>

<script>
/**
 * Fiscal year auto-fill functionality.
 * When a fiscal year is selected, automatically populate the date fields.
 * Canadian fiscal year: April 1 to March 31.
 */
document.addEventListener('DOMContentLoaded', function() {
    const fiscalYearSelect = document.getElementById('id_fiscal_year');
    const dateFromInput = document.getElementById('id_date_from');
    const dateToInput = document.getElementById('id_date_to');

    if (!fiscalYearSelect || !dateFromInput || !dateToInput) return;

    fiscalYearSelect.addEventListener('change', function() {
        const selectedYear = this.value;
        if (!selectedYear) {
            // Blank selection — clear dates to allow manual entry
            dateFromInput.value = '';
            dateToInput.value = '';
            return;
        }

        // Calculate fiscal year dates (April 1 to March 31)
        const startYear = parseInt(selectedYear, 10);
        const endYear = startYear + 1;

        // Format as YYYY-MM-DD for date inputs
        const dateFrom = startYear + '-04-01';
        const dateTo = endYear + '-03-31';

        dateFromInput.value = dateFrom;
        dateToInput.value = dateTo;
    });

    // Select all / deselect all for metrics (existing functionality)
    const selectAllLink = document.getElementById('select-all-metrics');
    const deselectAllLink = document.getElementById('deselect-all-metrics');

    if (selectAllLink) {
        selectAllLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('input[name="metrics"]').forEach(function(cb) {
                cb.checked = true;
            });
        });
    }

    if (deselectAllLink) {
        deselectAllLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('input[name="metrics"]').forEach(function(cb) {
                cb.checked = false;
            });
        });
    }
});
</script>
{% endblock %}
