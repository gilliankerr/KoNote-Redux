{% extends "reports/pdf_base.html" %}
{% load i18n %}

{% block title %}{% blocktrans with first=client.first_name last=client.last_name %}Progress Report — {{ first }} {{ last }}{% endblocktrans %}{% endblock %}

{% block content %}
<!-- Cover Page -->
<div class="pdf-cover">
    <h1>{% trans "Progress Report" %}</h1>
    <div class="subtitle">{{ client.first_name }} {{ client.last_name }}</div>
    <div class="meta">
        {% if client.record_id %}{% blocktrans with rid=client.record_id %}Record ID: {{ rid }}{% endblocktrans %}<br>{% endif %}
        {% blocktrans with date=generated_at|date:"Y-m-d" author=generated_by %}Generated {{ date }} by {{ author }}{% endblocktrans %}
    </div>
</div>

<!-- Client Information -->
<h2>{% trans "Client Information" %}</h2>
<dl>
    <dt>{% trans "Name" %}</dt>
    <dd>{{ client.first_name }} {{ client.last_name }}{% if client.middle_name %} ({{ client.middle_name }}){% endif %}</dd>
    {% if client.record_id %}
    <dt>{% trans "Record ID" %}</dt>
    <dd>{{ client.record_id }}</dd>
    {% endif %}
    {% if client.birth_date %}
    <dt>{% trans "Date of Birth" %}</dt>
    <dd>{{ client.birth_date }}</dd>
    {% endif %}
    <dt>{% trans "Status" %}</dt>
    <dd>
        {% if client.status == "active" %}
            <span class="badge badge-success">{% trans "Active" %}</span>
        {% elif client.status == "inactive" %}
            <span class="badge badge-warning">{% trans "Inactive" %}</span>
        {% else %}
            <span class="badge badge-neutral">{% trans "Discharged" %}</span>
        {% endif %}
    </dd>
</dl>

{% if enrolments %}
<h3>{% trans "Programme Enrolments" %}</h3>
<ul class="enrolment-list">
    {% for e in enrolments %}
    <li>{{ e.program.translated_name }}</li>
    {% endfor %}
</ul>
{% endif %}

<!-- Plan Sections & Targets -->
{% if sections %}
<h2>{% trans "Plan Sections & Targets" %}</h2>
{% for section in sections %}
<div class="avoid-break">
    <h3>{{ section.name }}</h3>
    {% for target in section.targets.all %}
    <div style="margin-left: 0.5cm; margin-bottom: 0.3cm;">
        <strong>{{ target.name }}</strong>
        {% if target.description %}<br><span style="color: #718096;">{{ target.description }}</span>{% endif %}
    </div>
    {% endfor %}
</div>
{% endfor %}
{% endif %}

<!-- Metric Progress -->
{% if metric_tables %}
<div class="page-break"></div>
<h2>{% trans "Metric Progress" %}</h2>
{% for table in metric_tables %}
<div class="avoid-break">
    <h3>{{ table.target_name }} — {{ table.metric_name }}</h3>
    {% if table.unit %}
    <div class="metric-summary">
        {% blocktrans with unit=table.unit %}Unit: {{ unit }}{% endblocktrans %}
        {% if table.min_value != None %} · {% blocktrans with val=table.min_value %}Min: {{ val }}{% endblocktrans %}{% endif %}
        {% if table.max_value != None %} · {% blocktrans with val=table.max_value %}Max: {{ val }}{% endblocktrans %}{% endif %}
        · {% blocktrans count counter=table.rows|length %}{{ counter }} measurement{% plural %}{{ counter }} measurements{% endblocktrans %}
    </div>
    {% endif %}
    <table>
        <thead>
            <tr>
                <th scope="col">{% trans "Date" %}</th>
                <th scope="col">{% trans "Value" %}</th>
                <th scope="col">{% trans "Author" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for row in table.rows %}
            <tr>
                <td>{{ row.date }}</td>
                <td>{{ row.value }}</td>
                <td>{{ row.author }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endfor %}
{% endif %}

<!-- Progress Notes -->
{% if notes %}
<div class="page-break"></div>
<h2>{% trans "Recent Progress Notes" %}</h2>
{% for note in notes %}
<div class="timeline-item avoid-break">
    <div class="date">
        {{ note.effective_date|date:"Y-m-d" }} — {{ note.author.display_name }}
        <span class="badge {% if note.note_type == 'quick' %}badge-neutral{% else %}badge-success{% endif %}">
            {{ note.get_note_type_display }}
        </span>
    </div>
    <div class="content">
        {% if note.notes_text %}{{ note.notes_text|truncatewords:80 }}{% endif %}
        {% if note.summary %}{{ note.summary|truncatewords:80 }}{% endif %}
    </div>
</div>
{% endfor %}
{% endif %}

<!-- Events -->
{% if events %}
<h2>{% trans "Recent Events" %}</h2>
{% for event in events %}
<div class="timeline-item avoid-break">
    <div class="date">
        {{ event.start_timestamp|date:"Y-m-d" }}
        {% if event.event_type %}— {{ event.event_type.name }}{% endif %}
    </div>
    <div class="content">
        {% if event.title %}<strong>{{ event.title }}</strong><br>{% endif %}
        {% if event.description %}{{ event.description|truncatewords:50 }}{% endif %}
    </div>
</div>
{% endfor %}
{% endif %}
{% endblock %}
