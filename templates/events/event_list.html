{% extends "base.html" %}

{% block title %}Events — {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <p>
        {% if client.status == "active" %}
            <span class="badge badge-success">Active</span>
        {% elif client.status == "inactive" %}
            <span class="badge badge-warning">Inactive</span>
        {% else %}
            <span class="badge badge-neutral">Discharged</span>
        {% endif %}
        {% if client.record_id %}— Record ID: {{ client.record_id }}{% endif %}
    </p>
</hgroup>

<div role="group">
    <a href="{% url 'events:event_create' client_id=client.pk %}" role="button">New Event</a>
    <a href="{% url 'events:alert_create' client_id=client.pk %}" role="button" class="outline">New Alert</a>
</div>

<!-- Tabs -->
<nav>
    <ul>
        <li><a href="{% url 'clients:client_detail' client_id=client.pk %}">Info</a></li>
        <li><a href="{% url 'plans:plan_view' client_id=client.pk %}">{{ term.plan|default:"Plan" }}</a></li>
        <li><a href="{% url 'notes:note_list' client_id=client.pk %}">{{ term.progress_note|default:"Notes" }}</a></li>
        <li><strong>Events</strong></li>
        <li><a href="{% url 'reports:client_analysis' client_id=client.pk %}">Analysis</a></li>
    </ul>
</nav>

<hr>

<!-- Active alerts -->
{% for alert in alerts %}
{% if alert.status == "default" %}
<article aria-label="alert" style="border-left: 4px solid #EF4444;">
    <header><strong>Alert</strong> — {{ alert.created_at|date:"Y-m-d" }}
        {% if alert.author %}<small>by {{ alert.author.display_name|default:alert.author }}</small>{% endif %}
    </header>
    <p>{{ alert.content }}</p>
    <footer>
        <a href="{% url 'events:alert_cancel' alert_id=alert.pk %}">Cancel Alert</a>
    </footer>
</article>
{% elif alert.status == "cancelled" %}
<article aria-label="cancelled alert" style="border-left: 4px solid #6B7280; opacity: 0.6;">
    <header>
        <span class="badge badge-danger">Cancelled</span>
        <strong>Alert</strong> — {{ alert.created_at|date:"Y-m-d" }}
    </header>
    <p><del>{{ alert.content }}</del></p>
    {% if alert.status_reason %}<p><small>Reason: {{ alert.status_reason }}</small></p>{% endif %}
</article>
{% endif %}
{% endfor %}

<!-- Combined Timeline -->
{% if timeline %}
<h2>Timeline</h2>
<div class="timeline">
    {% for entry in timeline %}
    <div class="timeline-item">
        {% if entry.type == "event" %}
        <div>
            {% if entry.obj.event_type %}
                <span class="program-dot" style="background-color: {{ entry.obj.event_type.colour_hex }}" aria-hidden="true"></span>
                <span class="badge" style="background-color: {{ entry.obj.event_type.colour_hex }}; color: #fff;">{{ entry.obj.event_type.name }}</span>
            {% else %}
                <span class="badge badge-neutral">Event</span>
            {% endif %}
            <strong>{{ entry.date|date:"Y-m-d H:i" }}</strong>
            {% if entry.obj.end_timestamp %} — {{ entry.obj.end_timestamp|date:"Y-m-d H:i" }}{% endif %}
        </div>
        {% if entry.obj.title %}<p><strong>{{ entry.obj.title }}</strong></p>{% endif %}
        {% if entry.obj.description %}<p>{{ entry.obj.description|truncatechars:200 }}</p>{% endif %}

        {% elif entry.type == "note" %}
        <div>
            {% if entry.obj.note_type == "quick" %}
                <span class="badge badge-info">{{ term.quick_note|default:"Quick Note" }}</span>
            {% else %}
                <span class="badge badge-success">Full Note</span>
            {% endif %}
            {% if entry.obj.status == "cancelled" %}
                <span class="badge badge-danger">Cancelled</span>
            {% endif %}
            <strong>{{ entry.date|date:"Y-m-d" }}</strong>
            — {{ entry.obj.author.display_name|default:entry.obj.author }}
            {% if entry.obj.author_program %}
                <small>({{ entry.obj.author_program.name }})</small>
            {% endif %}
        </div>
        {% if entry.obj.status == "cancelled" %}
            <p><del>{{ entry.obj.notes_text|truncatechars:200 }}</del></p>
        {% else %}
            <p>{{ entry.obj.notes_text|truncatechars:200 }}</p>
        {% endif %}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<p class="empty-state">No events or notes recorded yet. Add events or progress notes to build a timeline.</p>
{% endif %}
{% endblock %}
