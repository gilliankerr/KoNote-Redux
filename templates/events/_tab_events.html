{% load i18n %}
{% load permissions_tags %}
<!-- Partial: Events tab content -->
{% has_permission "event.view" as can_view_events %}
{% if user.is_admin and not can_view_events %}
<p class="notice" role="status">
    <small>{% blocktrans with program=term.program|default:"program" %}You are an administrator without {{ program }} assignments. To see data, ask another admin to assign you a {{ program }} role.{% endblocktrans %}</small>
</p>
{% endif %}
<div class="action-bar">
    <a href="{% url 'events:event_create' client_id=client.pk %}" role="button">{% trans "New Event" %}</a>
    <a href="{% url 'events:alert_create' client_id=client.pk %}" role="button" class="outline">{% trans "New Alert" %}</a>
</div>

<!-- Active alerts -->
{% has_permission "alert.cancel" as can_cancel_alert %}
{% has_permission "alert.recommend_cancel" as can_recommend_cancel %}
{% for alert in alerts %}
{% if alert.status == "default" %}
<article class="alert-card" aria-label="{% trans 'alert' %}">
    <header><strong>{% trans "Alert" %}</strong> — {{ alert.created_at|date:"Y-m-d" }}
        {% if alert.author %}<small class="secondary">{% trans "by" %} {{ alert.author.display_name|default:alert.author }}</small>{% endif %}
        {% if show_program_ui and alert.author_program %}<span class="badge" style="background-color: {{ alert.author_program.colour_hex }}; color: #fff;">{{ alert.author_program.translated_name }}</span>{% endif %}
    </header>
    <p>{{ alert.content }}</p>
    {% for rec in alert.cancellation_recommendations.all %}
        {% if rec.status == "pending" %}
        <p class="notice" role="status">
            <small>{% trans "Cancellation recommended" %} {{ rec.created_at|date:"Y-m-d" }}
            {% if rec.recommended_by %} {% trans "by" %} {{ rec.recommended_by.display_name|default:rec.recommended_by }}{% endif %}
            — {% trans "awaiting PM review" %}</small>
        </p>
        {% elif rec.status == "rejected" %}
        <p class="notice" role="status">
            <small>{% trans "Cancellation recommendation rejected" %} {{ rec.reviewed_at|date:"Y-m-d" }}
            {% if rec.review_note %} — {{ rec.review_note }}{% endif %}</small>
        </p>
        {% endif %}
    {% endfor %}
    <footer>
        {% if can_cancel_alert %}
            <a href="{% url 'events:alert_cancel' alert_id=alert.pk %}">{% trans "Cancel Alert" %}</a>
        {% elif can_recommend_cancel %}
            <a href="{% url 'events:alert_recommend_cancel' alert_id=alert.pk %}">{% trans "Recommend Cancellation" %}</a>
        {% endif %}
    </footer>
</article>
{% elif alert.status == "cancelled" %}
<article class="alert-card alert-card-cancelled" aria-label="{% trans 'cancelled alert' %}">
    <header>
        <span class="badge badge-danger">{% trans "Cancelled" %}</span>
        <strong>{% trans "Alert" %}</strong> — {{ alert.created_at|date:"Y-m-d" }}
    </header>
    <p><del>{{ alert.content }}</del></p>
    {% if alert.status_reason %}<p><small class="secondary">{% trans "Reason:" %} {{ alert.status_reason }}</small></p>{% endif %}
</article>
{% endif %}
{% endfor %}

<!-- Quick-log communication buttons -->
{% include "communications/_quick_log_buttons.html" %}

<!-- Combined Timeline -->
{% if timeline %}
<h2>{% trans "Timeline" %}</h2>
<div class="timeline">
    {% for entry in timeline %}
    <div class="timeline-item">
        {% if entry.type == "event" %}
        <div>
            {% if entry.obj.event_type %}
                <span class="program-dot" style="background-color: {{ entry.obj.event_type.colour_hex }}" aria-hidden="true"></span>
                <span class="badge" style="background-color: {{ entry.obj.event_type.colour_hex }}; color: #fff;">{{ entry.obj.event_type.name }}</span>
            {% else %}
                <span class="badge badge-neutral">{% trans "Event" %}</span>
            {% endif %}
            {% if show_program_ui and entry.obj.author_program %}
                <span class="badge" style="background-color: {{ entry.obj.author_program.colour_hex }}; color: #fff;">{{ entry.obj.author_program.translated_name }}</span>
            {% endif %}
            {% if entry.obj.all_day %}
                <span class="badge badge-info" title="{% trans 'All day event' %}">{% trans "All Day" %}</span>
                <strong>{{ entry.date|date:"Y-m-d" }}</strong>
                {% if entry.obj.end_timestamp %} — {{ entry.obj.end_timestamp|date:"Y-m-d" }}{% endif %}
            {% else %}
                <strong>{{ entry.date|date:"Y-m-d H:i" }}</strong>
                {% if entry.obj.end_timestamp %} — {{ entry.obj.end_timestamp|date:"Y-m-d H:i" }}{% endif %}
            {% endif %}
        </div>
        {% if entry.obj.title %}<p><strong>{{ entry.obj.title }}</strong></p>{% endif %}
        {% if entry.obj.description %}<p>{{ entry.obj.description|truncatechars:200 }}</p>{% endif %}

        {% elif entry.type == "note" %}
        <div>
            {% if entry.obj.note_type == "quick" %}
                <span class="badge badge-info">{{ term.quick_note|default:"Quick Note" }}</span>
            {% else %}
                <span class="badge badge-success">{% trans "Full Note" %}</span>
            {% endif %}
            {% if entry.obj.status == "cancelled" %}
                <span class="badge badge-danger">{% trans "Cancelled" %}</span>
            {% endif %}
            <strong>{{ entry.date|date:"Y-m-d" }}</strong>
            — {{ entry.obj.author.display_name|default:entry.obj.author }}
            {% if show_program_ui and entry.obj.author_program %}
                <span class="badge" style="background-color: {{ entry.obj.author_program.colour_hex }}; color: #fff;">{{ entry.obj.author_program.translated_name }}</span>
            {% elif entry.obj.author_program %}
                <small class="secondary">({{ entry.obj.author_program.translated_name }})</small>
            {% endif %}
        </div>
        {% if entry.obj.status == "cancelled" %}
            <p><del>{{ entry.obj.notes_text|truncatechars:200 }}</del></p>
        {% else %}
            <p>{{ entry.obj.notes_text|truncatechars:200 }}</p>
        {% endif %}

        {% elif entry.type == "communication" %}
        {% include "communications/_communication_card.html" with comm=entry.obj %}
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>{% trans "No events or notes recorded yet. Add events or progress notes to build a timeline." %}</p>
</div>
{% endif %}
