{% load i18n %}
{% load permissions_tags %}
<!-- Partial: Timeline tab content -->
{% has_permission "event.view" as can_view_events %}
{% if user.is_admin and not can_view_events %}
<p class="notice" role="status">
    <small>{% blocktrans with program=term.program|default:"program" %}You are an administrator without {{ program }} assignments. To see data, ask another admin to assign you a {{ program }} role.{% endblocktrans %}</small>
</p>
{% endif %}
{% has_permission "meeting.create" as can_create_meeting %}
<div class="action-bar" role="group" aria-label="{% trans 'Actions' %}">
    {% if can_create_meeting %}
    <a href="{% url 'events:meeting_create' client_id=client.pk %}" role="button">{% trans "Schedule Meeting" %}</a>
    {% endif %}
    <a href="{% url 'events:event_create' client_id=client.pk %}" role="button" class="outline">{% trans "Record Event" %}</a>
    <a href="{% url 'events:alert_create' client_id=client.pk %}" role="button" class="outline secondary">{% trans "New Alert" %}</a>
</div>

<!-- Active alerts -->
{% has_permission "alert.cancel" as can_cancel_alert %}
{% has_permission "alert.recommend_cancel" as can_recommend_cancel %}
{% for alert in alerts %}
{% if alert.status == "default" %}
<article class="alert-card" aria-label="{% trans 'alert' %}">
    <header><strong>{% trans "Alert" %}</strong> — <time datetime="{{ alert.created_at|date:'c' }}">{{ alert.created_at|date }}</time>
        {% if alert.author %}<small class="secondary">{% trans "by" %} {{ alert.author.display_name|default:alert.author }}</small>{% endif %}
        {% if show_program_ui and alert.author_program %}<span class="badge" style="background-color: {{ alert.author_program.colour_hex }}; color: #fff;">{{ alert.author_program.translated_name }}</span>{% endif %}
    </header>
    <p>{{ alert.content }}</p>
    {% for rec in alert.cancellation_recommendations.all %}
        {% if rec.status == "pending" %}
        <p class="notice" role="status">
            <small>{% trans "Cancellation recommended" %} <time datetime="{{ rec.created_at|date:'c' }}">{{ rec.created_at|date }}</time>
            {% if rec.recommended_by %} {% trans "by" %} {{ rec.recommended_by.display_name|default:rec.recommended_by }}{% endif %}
            — {% trans "awaiting PM review" %}</small>
        </p>
        {% elif rec.status == "rejected" %}
        <p class="notice" role="status">
            <small>{% trans "Cancellation recommendation rejected" %} <time datetime="{{ rec.reviewed_at|date:'c' }}">{{ rec.reviewed_at|date }}</time>
            {% if rec.review_note %} — {{ rec.review_note }}{% endif %}</small>
        </p>
        {% endif %}
    {% endfor %}
    <footer>
        {% if can_cancel_alert %}
            <a href="{% url 'events:alert_cancel' alert_id=alert.pk %}">{% trans "Cancel Alert" %}</a>
        {% elif can_recommend_cancel %}
            <a href="{% url 'events:alert_recommend_cancel' alert_id=alert.pk %}">{% trans "Recommend Cancellation" %}</a>
        {% endif %}
    </footer>
</article>
{% elif alert.status == "cancelled" %}
<article class="alert-card alert-card-cancelled" aria-label="{% trans 'cancelled alert' %}">
    <header>
        <span class="badge badge-danger">{% trans "Cancelled" %}</span>
        <strong>{% trans "Alert" %}</strong> — <time datetime="{{ alert.created_at|date:'c' }}">{{ alert.created_at|date }}</time>
    </header>
    <p><del>{{ alert.content }}</del></p>
    {% if alert.status_reason %}<p><small class="secondary">{% trans "Reason:" %} {{ alert.status_reason }}</small></p>{% endif %}
</article>
{% endif %}
{% endfor %}

<!-- Record a contact buttons -->
{% include "communications/_quick_log_buttons.html" %}

<!-- Timeline with filters (UXP5) -->
<h2>{% trans "Timeline" %}</h2>
<div id="timeline-section">
    <div class="filter-bar" role="group" aria-label="{% trans 'Filter timeline' %}">
        <button class="filter-btn{% if active_filter == 'all' or not active_filter %} filter-active{% endif %}"
                aria-pressed="{% if active_filter == 'all' or not active_filter %}true{% else %}false{% endif %}"
                hx-get="{% url 'events:event_list' client_id=client.pk %}?filter=all"
                hx-target="#timeline-entries"
                hx-swap="innerHTML">{% trans "All" %}</button>
        <button class="filter-btn{% if active_filter == 'notes' %} filter-active{% endif %}"
                aria-pressed="{% if active_filter == 'notes' %}true{% else %}false{% endif %}"
                hx-get="{% url 'events:event_list' client_id=client.pk %}?filter=notes"
                hx-target="#timeline-entries"
                hx-swap="innerHTML">{% trans "Notes" %}</button>
        <button class="filter-btn{% if active_filter == 'events' %} filter-active{% endif %}"
                aria-pressed="{% if active_filter == 'events' %}true{% else %}false{% endif %}"
                hx-get="{% url 'events:event_list' client_id=client.pk %}?filter=events"
                hx-target="#timeline-entries"
                hx-swap="innerHTML">{% trans "Events" %}</button>
        <button class="filter-btn{% if active_filter == 'communications' %} filter-active{% endif %}"
                aria-pressed="{% if active_filter == 'communications' %}true{% else %}false{% endif %}"
                hx-get="{% url 'events:event_list' client_id=client.pk %}?filter=communications"
                hx-target="#timeline-entries"
                hx-swap="innerHTML">{% trans "Contacts" %}</button>
    </div>
    <div id="timeline-entries">
        {% include "events/_timeline_entries.html" %}
    </div>
</div>
