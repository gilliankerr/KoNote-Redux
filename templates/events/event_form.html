{% extends "base.html" %}
{% load i18n %}

{% block title %}{% if editing %}{% trans "Edit" %}{% else %}{% trans "New" %}{% endif %} {% trans "Event" %} â€” {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{% if editing %}{% trans "Edit" %}{% else %}{% trans "New" %}{% endif %} {% blocktrans with first=client.first_name last=client.last_name %}Event for {{ first }} {{ last }}{% endblocktrans %}</h1>
</hgroup>

<form method="post" id="event-form">
    {% csrf_token %}

    {# Title field #}
    <label for="{{ form.title.id_for_label }}">
        {{ form.title.label }}
    </label>
    {{ form.title }}
    {% if form.title.errors %}
    <small class="badge badge-danger" role="alert">{{ form.title.errors.0 }}</small>
    {% endif %}

    {# Event type field #}
    <label for="{{ form.event_type.id_for_label }}">
        {{ form.event_type.label }}
    </label>
    {{ form.event_type }}
    {% if form.event_type.errors %}
    <small class="badge badge-danger" role="alert">{{ form.event_type.errors.0 }}</small>
    {% endif %}

    {# All day toggle - using Pico CSS switch style #}
    <fieldset>
        <label for="{{ form.all_day.id_for_label }}">
            {{ form.all_day }}
            {{ form.all_day.label }}
        </label>
        <small id="all_day_help">{{ form.all_day.help_text }}</small>
    </fieldset>

    {# Date-only fields (shown when all_day is checked) #}
    <div id="date-only-fields" style="display: none;" aria-live="polite">
        <div class="grid">
            <div>
                <label for="{{ form.start_date.id_for_label }}">
                    {{ form.start_date.label }}
                    <abbr title="{% trans 'required' %}">*</abbr>
                </label>
                {{ form.start_date }}
                {% if form.start_date.errors %}
                <small class="badge badge-danger" role="alert">{{ form.start_date.errors.0 }}</small>
                {% endif %}
            </div>
            <div>
                <label for="{{ form.end_date.id_for_label }}">
                    {{ form.end_date.label }}
                </label>
                {{ form.end_date }}
                {% if form.end_date.errors %}
                <small class="badge badge-danger" role="alert">{{ form.end_date.errors.0 }}</small>
                {% endif %}
            </div>
        </div>
    </div>

    {# DateTime fields (shown when all_day is NOT checked) #}
    <div id="datetime-fields" aria-live="polite">
        <div class="grid">
            <div>
                <label for="{{ form.start_timestamp.id_for_label }}">
                    {% trans "Start Date & Time" %}
                    <abbr title="{% trans 'required' %}">*</abbr>
                </label>
                {{ form.start_timestamp }}
                {% if form.start_timestamp.errors %}
                <small class="badge badge-danger" role="alert">{{ form.start_timestamp.errors.0 }}</small>
                {% endif %}
            </div>
            <div>
                <label for="{{ form.end_timestamp.id_for_label }}">
                    {% trans "End Date & Time" %}
                </label>
                {{ form.end_timestamp }}
                {% if form.end_timestamp.errors %}
                <small class="badge badge-danger" role="alert">{{ form.end_timestamp.errors.0 }}</small>
                {% endif %}
            </div>
        </div>
    </div>

    {# Description field #}
    <label for="{{ form.description.id_for_label }}">
        {{ form.description.label }}
    </label>
    {{ form.description }}
    {% if form.description.errors %}
    <small class="badge badge-danger" role="alert">{{ form.description.errors.0 }}</small>
    {% endif %}

    {# Related note field (hidden if not relevant) #}
    {% if form.related_note.field.queryset.exists %}
    <label for="{{ form.related_note.id_for_label }}">
        {{ form.related_note.label }}
    </label>
    {{ form.related_note }}
    {% if form.related_note.errors %}
    <small class="badge badge-danger" role="alert">{{ form.related_note.errors.0 }}</small>
    {% endif %}
    {% endif %}

    <div role="group">
        <button type="submit">{% if editing %}{% trans "Save Changes" %}{% else %}{% trans "Create Event" %}{% endif %}</button>
        <a href="{% url 'events:event_list' client_id=client.pk %}" role="button" class="outline">{% trans "Cancel" %}</a>
    </div>
</form>

<script>
(function() {
    'use strict';

    var allDayCheckbox = document.getElementById('{{ form.all_day.id_for_label }}');
    var dateOnlyFields = document.getElementById('date-only-fields');
    var datetimeFields = document.getElementById('datetime-fields');

    function toggleDateFields() {
        var isAllDay = allDayCheckbox.checked;

        if (isAllDay) {
            dateOnlyFields.style.display = 'block';
            datetimeFields.style.display = 'none';
            // Update aria-hidden for screen readers
            dateOnlyFields.setAttribute('aria-hidden', 'false');
            datetimeFields.setAttribute('aria-hidden', 'true');
        } else {
            dateOnlyFields.style.display = 'none';
            datetimeFields.style.display = 'block';
            dateOnlyFields.setAttribute('aria-hidden', 'true');
            datetimeFields.setAttribute('aria-hidden', 'false');
        }
    }

    // Run on page load to handle edit mode or validation errors
    toggleDateFields();

    // Listen for changes
    allDayCheckbox.addEventListener('change', toggleDateFields);
})();
</script>
{% endblock %}
