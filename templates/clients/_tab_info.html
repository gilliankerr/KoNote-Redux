{% load i18n %}
<!-- Partial: Info tab content -->
<div class="action-bar">
    {% if not is_receptionist and not client.is_anonymised %}
    <a href="{% url 'clients:client_edit' client_id=client.pk %}" role="button" class="outline">{% trans "Edit" %}</a>
    {% endif %}
    <a href="{% url 'clients:client_list' %}" class="back-link">&larr; {% trans "Back to List" %}</a>
    {% if not client.is_anonymised and not is_receptionist and not is_executive_only and not is_admin_only %}
    <a href="{% url 'reports:client_progress_pdf' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Export PDF" %}</a>
    {% endif %}
    {% if not client.is_anonymised and user_role == "program_manager" %}
    <a href="{% url 'reports:client_export' client_id=client.pk %}" role="button" class="outline secondary">{% trans "Export All Data" %}</a>
    {% endif %}
    {% if pending_erasure %}
    <span class="badge badge-warning">{% trans "Erasure Pending" %}</span>
    {% endif %}
</div>

{# Anonymised record banner #}
{% if client.is_anonymised %}
<article aria-label="notice" style="border-left: 4px solid var(--pico-muted-border-color); background: var(--pico-card-background-color);">
    <strong>{% trans "This record has been anonymised." %}</strong>
    {% trans "Identifying information has been removed. Service records are retained for statistical and compliance purposes." %}
</article>
{% endif %}

{# Consent warning - only shown when missing #}
{% if not client.consent_given_at %}
<section id="consent-section" aria-labelledby="consent-heading">
    {% include "clients/_consent_display.html" %}
</section>
{% endif %}

{# Quick info row - high-frequency data for front desk #}
<section class="quick-info-section">
    <dl class="quick-info">
        {% if visible_fields.birth_date and client.birth_date %}
        <div class="quick-info-item">
            <dt>{% trans "DOB" %}</dt>
            <dd>{{ client.birth_date }}</dd>
        </div>
        {% endif %}
        {% if enrolments %}
        <div class="quick-info-item">
            <dt>{{ term.program_plural|default:"Programs" }}</dt>
            <dd>
                {% for e in enrolments %}
                <span class="program-dot" style="background-color: {{ e.program.colour_hex }}" aria-hidden="true"></span>{{ e.program.translated_name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
            </dd>
        </div>
        {% endif %}
    </dl>
</section>

{# Additional details - only if client has middle name or custom data #}
{% if client.middle_name or custom_data %}
<section>
    <details open>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Details" %}</h2></summary>

        {% if client.middle_name %}
        <dl class="info-grid-compact" style="margin-top: var(--kn-space-base);">
            <div class="info-field">
                <dt>{% trans "Middle Name" %}</dt>
                <dd>{{ client.middle_name }}</dd>
            </div>
        </dl>
        {% endif %}

        {% if custom_data %}
        <div id="custom-fields-section">
            {% include "clients/_custom_fields_display.html" %}
        </div>
        {% endif %}
    </details>
</section>
{% endif %}

{# Consent details (when recorded) - collapsed by default #}
{% if client.consent_given_at %}
<section id="consent-section">
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Privacy Consent" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            {% include "clients/_consent_display.html" %}
        </div>
    </details>
</section>
{% endif %}

{# Cross-program sharing consent — visible to staff and above #}
{% if not is_receptionist and not client.is_anonymised %}
<section>
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Cross-Program Sharing" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            {% if client.cross_program_sharing_consent %}
            <p><span class="badge badge-success">{% trans "Consent given" %}</span></p>
            <p class="secondary">{% trans "This participant has consented to sharing clinical information across programs." %}</p>
            {% else %}
            <p><span class="badge badge-neutral">{% trans "No consent" %}</span></p>
            <p class="secondary">{% trans "Clinical notes are only visible within the program where they were recorded. Under Ontario privacy law (PHIPA), express consent is required before clinical information can be shared across programs." %}</p>
            {% endif %}
            <small class="secondary"><em>{% trans "Note: Cross-program note filtering will be enforced in a future update. This setting is being recorded now for when enforcement is enabled." %}</em></small>
        </div>
    </details>
</section>
{% endif %}

{# Privacy & Data Management — collapsed, PM+ only, not shown for anonymised clients #}
{% if is_pm_or_admin and not client.is_anonymised %}
<section>
    <details>
        <summary><h2 style="display: inline; font-size: 1rem; margin: 0;">{% trans "Privacy & Data Management" %}</h2></summary>
        <div style="margin-top: var(--kn-space-base);">
            <p class="secondary">{% trans "These actions are for privacy compliance and data governance. Data erasure is permanent and irreversible." %}</p>
            {% if pending_erasure %}
            <span class="badge badge-warning">{% trans "Erasure Pending" %}</span>
            {% else %}
            <a href="{% url 'clients:client_erasure_request' client_id=client.pk %}" class="secondary" style="font-size: 0.875rem;">{% trans "Request Irreversible Data Erasure" %}</a>
            {% endif %}
        </div>
    </details>
</section>
{% endif %}
