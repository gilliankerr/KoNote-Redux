{% extends "base.html" %}

{% block title %}{{ client.first_name }} {{ client.last_name }} — {{ site.product_name|default:"KoNote" }}{% endblock %}

{% block content %}
<hgroup>
    <h1>{{ client.first_name }} {{ client.last_name }}</h1>
    <p>
        {% if client.status == "active" %}
            <span class="badge badge-success">Active</span>
        {% elif client.status == "inactive" %}
            <span class="badge badge-warning">Inactive</span>
        {% else %}
            <span class="badge badge-neutral">Discharged</span>
        {% endif %}
        {% if client.record_id %}— Record ID: {{ client.record_id }}{% endif %}
    </p>
</hgroup>

<div role="group">
    <a href="{% url 'clients:client_edit' client_id=client.pk %}" role="button" class="outline">Edit</a>
    <a href="{% url 'clients:client_list' %}" role="button" class="outline secondary">Back to List</a>
    <a href="{% url 'reports:client_progress_pdf' client_id=client.pk %}" role="button" class="outline secondary">Export PDF</a>
</div>

<!-- Tabs -->
<nav>
    <ul>
        <li><strong>Info</strong></li>
        <li><a href="{% url 'plans:plan_view' client_id=client.pk %}">{{ term.plan|default:"Plan" }}</a></li>
        <li><a href="{% url 'notes:note_list' client_id=client.pk %}">{{ term.progress_note|default:"Notes" }}</a></li>
        <li><a href="{% url 'events:event_list' client_id=client.pk %}">Events</a></li>
        <li><a href="{% url 'reports:client_analysis' client_id=client.pk %}">Analysis</a></li>
    </ul>
</nav>

<hr>

<!-- Info Tab -->
<section>
    <h2>Basic Information</h2>
    <dl>
        <dt>First Name</dt><dd>{{ client.first_name }}</dd>
        <dt>Last Name</dt><dd>{{ client.last_name }}</dd>
        {% if client.middle_name %}<dt>Middle Name</dt><dd>{{ client.middle_name }}</dd>{% endif %}
        {% if client.birth_date %}<dt>Date of Birth</dt><dd>{{ client.birth_date }}</dd>{% endif %}
        {% if client.record_id %}<dt>Record ID</dt><dd>{{ client.record_id }}</dd>{% endif %}
    </dl>

    {% if enrolments %}
    <h3>{{ term.program_plural|default:"Programs" }}</h3>
    <ul>
        {% for e in enrolments %}
        <li>
            <span class="program-dot" style="background-color: {{ e.program.colour_hex }}" aria-hidden="true"></span>
            {{ e.program.name }}
        </li>
        {% endfor %}
    </ul>
    {% endif %}

    {% if custom_data %}
    <hr>
    <h2>Additional Details</h2>
    <form method="post" action="{% url 'clients:client_save_custom_fields' client_id=client.pk %}">
        {% csrf_token %}
        {% for group in custom_data %}
        <fieldset>
            <legend>{{ group.group.title }}</legend>
            {% for item in group.fields %}
            <label for="custom_{{ item.field_def.pk }}">
                {{ item.field_def.name }}
                {% if item.field_def.is_required %}<abbr title="required">*</abbr>{% endif %}
                {% if item.field_def.is_sensitive %}<small>(encrypted)</small>{% endif %}
            </label>
            {% if item.field_def.input_type == "textarea" %}
                <textarea name="custom_{{ item.field_def.pk }}" id="custom_{{ item.field_def.pk }}" rows="3" placeholder="{{ item.field_def.placeholder }}" {% if item.field_def.is_required %}required{% endif %}>{{ item.value }}</textarea>
            {% elif item.field_def.input_type == "select" %}
                <select name="custom_{{ item.field_def.pk }}" id="custom_{{ item.field_def.pk }}" {% if item.field_def.is_required %}required{% endif %}>
                    <option value="">Select…</option>
                    {% for opt in item.field_def.options_json %}
                    <option value="{{ opt }}" {% if item.value == opt %}selected{% endif %}>{{ opt }}</option>
                    {% endfor %}
                </select>
            {% elif item.field_def.input_type == "date" %}
                <input type="date" name="custom_{{ item.field_def.pk }}" id="custom_{{ item.field_def.pk }}" value="{{ item.value }}" {% if item.field_def.is_required %}required{% endif %}>
            {% elif item.field_def.input_type == "number" %}
                <input type="number" name="custom_{{ item.field_def.pk }}" id="custom_{{ item.field_def.pk }}" value="{{ item.value }}" placeholder="{{ item.field_def.placeholder }}" {% if item.field_def.is_required %}required{% endif %}>
            {% else %}
                <input type="text" name="custom_{{ item.field_def.pk }}" id="custom_{{ item.field_def.pk }}" value="{{ item.value }}" placeholder="{{ item.field_def.placeholder }}" {% if item.field_def.is_required %}required{% endif %}>
            {% endif %}
            {% endfor %}
        </fieldset>
        {% endfor %}
        <button type="submit">Save Custom Fields</button>
    </form>
    {% endif %}
</section>
{% endblock %}
