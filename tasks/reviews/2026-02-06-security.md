# Security Review Report: KoNote2
**Date:** 2026-02-06
**Reviewer:** Senior Application Security Engineer
**Verdict:** FAIL

## Executive Summary

The application has failed the security gate checks due to the presence of unencrypted sensitive data (outcome ratings and plan targets) and the lack of a viable key rotation mechanism. While the application implements strong RBAC and generally good security practices (CSP, Audit Logging), the failure to encrypt all PII fields as required by the threat model and the inability to rotate keys without data loss prevents a "Production Ready" verdict.

**Gate Check Status:** FAIL
**Production Ready:** With Fixes
**Critical Issues:** 1
**High Issues:** 1
**Medium Issues:** 1
**Low Issues:** 0

## Gate Check Results Table

| Gate | Requirement | Status | Evidence |
|------|-------------|--------|----------|
| G1 | No Critical vulnerabilities found | **FAIL** | Unencrypted sensitive data found (see CRITICAL-001). |
| G2 | All PII fields use `_*_encrypted` BinaryField + property accessor | **FAIL** | `MetricValue.value`, `PlanTarget.name`, `PlanTarget.description` are plaintext. |
| G3 | ProgramAccessMiddleware in MIDDLEWARE and enforcing on all client routes | **PASS** | `konote/middleware/program_access.py` enforces regex patterns; `CLIENT_URL_PATTERNS` covers client data. |
| G4 | AuditMiddleware logging to separate "audit" database | **PASS** | `konote/middleware/audit.py` uses `using("audit")`; router configured in `konote/db_router.py`. |
| G5 | Session cookies: HttpOnly=True, Secure=True, SameSite=Lax | **PASS** | Verified in `konote/settings/base.py`. |
| G6 | DEBUG=False in production settings | **PASS** | Verified in `konote/settings/production.py`. |
| G7 | FIELD_ENCRYPTION_KEY loaded from environment (not hardcoded) | **PASS** | Verified in `konote/settings/base.py`. |

## Findings

### [CRITICAL-001] Unencrypted Outcome Ratings and Plan Data
- **Location:** `apps/notes/models.py:284` (`MetricValue`), `apps/plans/models.py:78` (`PlanTarget`), `apps/plans/models.py:97` (`PlanTargetRevision`)
- **Issue:** The application stores sensitive client health outcomes (ratings/scores) and plan goals in plaintext `CharField` and `TextField`. The requirement states "All PII fields" must be encrypted. Outcome ratings (e.g., substance use frequency, mental health scores) and specific treatment goals are highly sensitive PII/PHI.
- **Impact:** In the event of a database compromise (Tertiary Threat), sensitive client health data would be exposed in cleartext, violating the architectural decision to encrypt PII at rest.
- **Fix:**
    1.  Modify `MetricValue` to replace `value` with `_value_encrypted` (BinaryField) and add a property accessor using `konote.encryption`.
    2.  Modify `PlanTarget` to encrypt `name` and `description`.
    3.  Modify `PlanTargetRevision` to encrypt `name`, `description`, and `status_reason`.
- **Test:** Inspect the database schema to verify fields are `bytea` (PostgreSQL) or `BLOB`. Attempt to read raw values via SQL; they should be unreadable ciphertext.

### [HIGH-001] Missing Key Rotation Capability
- **Location:** `konote/encryption.py:25`
- **Issue:** The `_get_fernet` function initializes a `Fernet` instance with a single key from `settings.FIELD_ENCRYPTION_KEY`. It does not support `MultiFernet` or a list of keys.
- **Impact:** It is impossible to rotate the encryption key without causing data loss (inability to decrypt existing data). Safe key rotation is a critical requirement for long-term data protection.
- **Fix:** Update `konote/encryption.py` to support a comma-separated list of keys in `FIELD_ENCRYPTION_KEY`. Use `cryptography.fernet.MultiFernet` to allow decryption with old keys while encrypting with the new primary key.
- **Test:**
    1.  Set `FIELD_ENCRYPTION_KEY` to Key A. Encrypt data.
    2.  Set `FIELD_ENCRYPTION_KEY` to "Key B, Key A".
    3.  Verify the application can still decrypt data encrypted with Key A.
    4.  Verify new data is encrypted with Key B.

### [MEDIUM-001] Decryption Error Indicator Leak
- **Location:** `konote/encryption.py:58`
- **Issue:** When decryption fails, the `decrypt_field` function returns the string `"[decryption error]"`. This string is passed directly to the UI.
- **Impact:** While not a direct vulnerability, displaying internal error markers to end-users is bad practice and confirms to an attacker that the field is encrypted and that the key/data is corrupt. It acts as an information leak regarding the system's internal state.
- **Fix:** Log the error silently and return an empty string or a generic, user-friendly message at the view level.
- **Test:** Manually corrupt a BinaryField in the database and view the record in the browser. Ensure the UI handles the missing value gracefully without showing the raw error marker.

## Regression Tests Needed

| Component | Test Case |
|-----------|-----------|
| Encryption | Verify `MetricValue` encryption/decryption round-trip. |
| Encryption | Verify `PlanTarget` encryption/decryption round-trip. |
| Encryption | Verify `MultiFernet` key rotation (decrypt with secondary key). |
| Reports | Verify CSV/PDF exports still work correctly with encrypted metrics (must decrypt before export). |
| Search | Verify `client_search` (which does in-memory filtering) handles encrypted fields correctly. |

## Recommendations

1.  **Implement MultiFernet:** Immediately upgrade `konote/encryption.py` to use `MultiFernet` to support key rotation.
2.  **Audit "Sensitive" Flag:** Review the `is_sensitive` flag on `CustomFieldDefinition`. Currently, `ClientDetailValue` encrypts based on this flag. Ensure all default fields that might contain PII are set to sensitive by default.
3.  **Review Username Logging:** `apps/auth_app/views.py` logs usernames on error. Ensure usernames are not considered PII in your organization (e.g. `firstname.lastname`). If they are, hash them in logs.
4.  **Strengthen Validation:** Ensure `MetricValue` validation (min/max/unit) happens *before* encryption to ensure data integrity constraints are respected.
