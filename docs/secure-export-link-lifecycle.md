# SecureExportLink Lifecycle

How export download links are created, used, and cleaned up in KoNote.

## Overview

When a user exports data (metric reports, funder reports, or client data), the system does **not** stream the file directly to their browser. Instead, it:

1. Saves the file to a secure temporary folder on the server
2. Creates a database record (a `SecureExportLink`) with a unique ID
3. Shows the user a download link they can use within 24 hours

This approach gives administrators visibility and control over what data leaves the system.

## Flow Diagram

```
User submits          File saved to         SecureExportLink         User shown
export form    --->   SECURE_EXPORT_DIR  --->  created in DB   --->  download page
                                                    |
                                                    |  (if elevated)
                                                    v
                                              Email sent to
                                              all admins
                                                    |
                                              10-minute delay
                                              before download
                                              is allowed
                                                    |
                       +----------------------------+----------------------------+
                       |                            |                            |
                       v                            v                            v
                  User clicks              Admin revokes link            Link expires
                  download link            from Manage page              after 24 hours
                       |                            |                            |
                       v                            v                            v
                  File served              File deleted from             cleanup_expired_exports
                  + audit logged           disk + audit logged           deletes DB record + file
```

## Step-by-Step Lifecycle

### 1. Creation

**What triggers it:** A user submits one of three export forms:

| Export Type | URL | Who Can Use It |
|---|---|---|
| Metric Report | `/reports/export/` | Admins (any program) or Program Managers (their programs) |
| Funder Report | `/reports/funder-report/` | Admins (any program) or Program Managers (their programs) |
| Client Data | `/reports/client-data-export/` | Admins only |

**What happens behind the scenes:**

1. The export view validates the form (program, date range, recipient, etc.)
2. The data is queried and formatted as CSV or PDF
3. The helper function `_save_export_and_create_link()` in `apps/reports/views.py`:
   - Creates the export directory if it does not exist (`SECURE_EXPORT_DIR`)
   - Generates a UUID (universally unique identifier -- a random string that is practically impossible to guess)
   - Saves the file as `{uuid}_{filename}` in the export directory
   - Creates a `SecureExportLink` database record with an expiry time
   - Determines whether this is an "elevated" export (see below)
4. An audit log entry is written recording who created the export, what was exported, and who the stated recipient is
5. The user is shown a page with the download link

**Recipient tracking:** Every export form requires the user to say who will receive the data (self, colleague, funder, or other). This is recorded for accountability.

### 2. Token Generation

The download link uses the `SecureExportLink` record's primary key, which is a UUID (version 4). This is a 128-bit random value formatted as a string like `a1b2c3d4-e5f6-7890-abcd-ef1234567890`.

- UUIDs are generated by Python's `uuid.uuid4()` function using cryptographically secure randomness
- The URL format is: `/reports/download/{uuid}/`
- There is no sequential numbering -- you cannot guess another user's link by changing a number
- The UUID is used as both the database primary key and part of the filename on disk

### 3. Expiration

**Default expiry:** 24 hours after creation.

This is controlled by the `SECURE_EXPORT_LINK_EXPIRY_HOURS` environment variable (defaults to `24` if not set). The exact expiry timestamp is stored in the `expires_at` field on the database record.

**How expiry is checked:**

- Every time someone tries to download a file, the `is_valid()` method checks whether the current time has passed `expires_at`
- If expired, the user sees a friendly "This link has expired" page with instructions to create a new export
- Expired links are **not** automatically deleted from the database -- that is handled by the cleanup command (see step 7)

### 4. Access Control

**Who can download a link:**

- **The person who created it** -- always
- **Any admin** -- for oversight purposes

No one else can download the file, even if they have the link URL.

**Additional checks at download time:**

1. Is the user logged in? (required)
2. Is the link revoked? If yes, show "revoked" page
3. Is the link expired? If yes, show "expired" page
4. Is this an elevated export still in its delay period? If yes, show "pending" page
5. Does the file still exist on disk? If not, show "file unavailable" page
6. Is the file path within `SECURE_EXPORT_DIR`? If not, reject (path traversal protection)

**Admin management:** Admins can view all recent export links (last 7 days) at `/reports/export-links/`. This page shows:

- Who created each export and when
- What type of export and how many clients
- Who the stated recipient is
- How many times it has been downloaded and by whom
- Current status (Active, Pending, Expired, Revoked, File Missing)

### 5. Download

When a user clicks a valid download link:

1. The system verifies all access control checks (see above)
2. The download count is incremented atomically (prevents race conditions if two people click at the same time)
3. The `last_downloaded_at` and `last_downloaded_by` fields are updated
4. An audit log entry is written recording the download (separate from the creation audit)
5. The file is streamed to the browser as an attachment using Django's `FileResponse`
6. The browser's download dialog shows the original filename (e.g., `metric_export_Youth_Program_2025-04-01_2026-03-31.csv`)

### 6. Elevated Exports

Exports are automatically flagged as "elevated" when either:

- The export contains **100 or more clients**, OR
- The export **includes clinical note content**

**What happens with elevated exports:**

1. The `is_elevated` flag is set to `True` on the database record
2. An email notification is sent to all active admin users
3. The download link is **not immediately active** -- there is a delay (default: 10 minutes)
4. During the delay, admins can review the export on the Manage Export Links page and revoke it if needed
5. After the delay passes, the link becomes downloadable normally

**The delay period** is controlled by the `ELEVATED_EXPORT_DELAY_MINUTES` environment variable (defaults to `10`).

**The email notification** includes:
- Who is exporting and their email address
- How many clients are in the export
- Whether clinical notes are included
- Who the stated recipient is
- When the download will become available
- A link to the admin management page where the export can be revoked

If email sending fails (e.g., email is not configured), the export is still created. A warning is logged but the process is not blocked.

### 7. Revocation

Admins can revoke any active or pending export link from the Manage Export Links page (`/reports/export-links/`).

**What happens when a link is revoked:**

1. The `revoked` flag is set to `True`
2. The `revoked_by` and `revoked_at` fields are recorded
3. The file is deleted from disk immediately
4. An audit log entry is written recording who revoked it
5. Any future download attempts show a "This link has been revoked" page

Revocation is a POST-only action with a confirmation prompt.

### 8. Cleanup

The management command `cleanup_expired_exports` handles two types of cleanup:

**Step 1 -- Expired link cleanup:**
- Finds all `SecureExportLink` records that expired more than 1 day ago (grace period)
- Deletes the database record first, then the file on disk
- If the file deletion fails, the orphan file is caught in step 2

**Step 2 -- Orphan file cleanup:**
- Scans the `SECURE_EXPORT_DIR` folder
- Finds any files that have no matching database record
- Deletes them (these can appear from crashes, failed deletions, or manual intervention)

**Running the cleanup:**

```
# Actually delete expired links and orphan files
python manage.py cleanup_expired_exports

# Preview what would be deleted (no changes made)
python manage.py cleanup_expired_exports --dry-run
```

This command should be run as a daily scheduled task (cron job). See the [Export Runbook](export-runbook.md) for setup instructions.

**On Railway:** Files are stored in `/tmp` which is ephemeral -- files disappear when the container restarts or redeploys. This means Railway effectively does its own cleanup, but the database records still need to be cleaned up by the command.

### 9. Audit Trail

Every step of the lifecycle is logged in the audit database:

| Event | Audit Action | Resource Type | What's Recorded |
|---|---|---|---|
| Export created | `export` | `metric_report`, `funder_report`, or `client_data` | Who, what program, filters used, client count, recipient, link ID |
| File downloaded | `export` | `export_download` | Who downloaded, link ID, original creator, export type, client count |
| Link revoked | `update` | `export_link_revoked` | Who revoked, link ID, original creator, export type, client count |

All audit entries include:
- Timestamp
- User ID and display name
- Client IP address
- Structured metadata (JSON) with the details listed above

### 10. Individual Client Exports (Note)

Individual client exports (`/reports/client/{id}/export/`) work differently from the bulk exports described above. They stream the file directly to the browser (no SecureExportLink is created) because:

- They export a single client's data (not bulk)
- They require the user to have an active program role for that client
- They are always audit logged

## Key Files

| File | Purpose |
|---|---|
| `apps/reports/models.py` | `SecureExportLink` model definition |
| `apps/reports/views.py` | Export views + `_save_export_and_create_link()` helper |
| `apps/reports/pdf_views.py` | PDF export views + individual client export |
| `apps/reports/utils.py` | Permission checks (`can_create_export`) |
| `apps/reports/forms.py` | Export forms with recipient tracking |
| `apps/reports/csv_utils.py` | CSV injection protection + filename sanitisation |
| `apps/reports/management/commands/cleanup_expired_exports.py` | Cleanup command |
| `templates/reports/export_link_created.html` | Success page with download link |
| `templates/reports/export_link_pending.html` | Elevated export delay page |
| `templates/reports/export_link_expired.html` | Expired/revoked/missing page |
| `templates/reports/manage_export_links.html` | Admin management page |
| `templates/reports/email/elevated_export_alert.txt` | Admin notification (plain text) |
| `templates/reports/email/elevated_export_alert.html` | Admin notification (HTML) |

## Configuration

| Setting | Environment Variable | Default | Description |
|---|---|---|---|
| Export directory | `SECURE_EXPORT_DIR` | System temp + `konote_exports` | Where export files are saved on disk |
| Link expiry | `SECURE_EXPORT_LINK_EXPIRY_HOURS` | `24` | Hours before a download link expires |
| Elevated delay | `ELEVATED_EXPORT_DELAY_MINUTES` | `10` | Minutes before an elevated export can be downloaded |
| Email backend | `EMAIL_BACKEND` | Console (dev) | Must be SMTP in production for notifications |
| From address | `DEFAULT_FROM_EMAIL` | `KoNote <noreply@konote2.app>` | Sender address for notification emails |
