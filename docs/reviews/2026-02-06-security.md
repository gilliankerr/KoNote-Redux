# Security Review Report: KoNote

**Date:** 2026-02-06
**External Reviewer:** Jules (Google AI coding agent)
**Internal Verification:** Claude Code (same session)
**Verdict:** PASS WITH FIXES

---

## Executive Summary

Jules reviewed the codebase against the Security review prompt (Prompt A from
`tasks/code-review-framework.md`). It found 3 issues. Internal verification
confirmed 2 of the 3 findings and downgraded the severity of one.

**Gate Check Status:** FAIL (G2 — unencrypted PlanTarget fields)
**Production Ready:** With Fixes
**Critical Issues:** 0 (downgraded from Jules' 1 — see verification notes)
**High Issues:** 2
**Medium Issues:** 1
**Low Issues:** 0

---

## Gate Check Results

| Gate | Requirement | Status | Evidence |
|------|-------------|--------|----------|
| G1 | No Critical vulnerabilities found | **PASS** | No critical issues after verification |
| G2 | All PII fields use encrypted BinaryField + property accessor | **FAIL** | `PlanTarget.name`, `.description`, `PlanTargetRevision` fields are plaintext |
| G3 | ProgramAccessMiddleware in MIDDLEWARE and enforcing on all client routes | **PASS** | `konote/middleware/program_access.py` enforces regex patterns |
| G4 | AuditMiddleware logging to separate "audit" database | **PASS** | `konote/middleware/audit.py` uses `using("audit")` |
| G5 | Session cookies: HttpOnly=True, Secure=True, SameSite=Lax | **PASS** | Verified in `konote/settings/base.py` |
| G6 | DEBUG=False in production settings | **PASS** | Verified in `konote/settings/production.py` |
| G7 | FIELD_ENCRYPTION_KEY loaded from environment (not hardcoded) | **PASS** | Verified in `konote/settings/base.py` |

---

## Findings

### [HIGH-001] Unencrypted Plan Target Fields

- **Location:** `apps/plans/models.py:88-91` (PlanTarget), `apps/plans/models.py:110-113` (PlanTargetRevision)
- **Issue:** `PlanTarget.name`, `.description`, `.status_reason` and the corresponding `PlanTargetRevision` fields store client-specific treatment goals in plaintext. Examples: "Manage anxiety and panic attacks", "Reduce substance use frequency."
- **Impact:** In a database breach, client treatment goals are exposed in cleartext. These are sensitive health information even if client names are encrypted.
- **Fix:** Add `_name_encrypted`, `_description_encrypted`, `_status_reason_encrypted` BinaryFields with property accessors using `konote.encryption`, matching the pattern in `ProgressNote`.
- **Test:** Inspect database — fields should be `bytea`. Verify plan detail pages still display correctly.

**Jules' original severity:** CRITICAL — included `MetricValue.value` in same finding.
**Verification note:** `MetricValue.value` (notes/models.py:216) stores context-free numbers (e.g. "7" on a 1-10 scale). Without the client's name (which IS encrypted), these don't identify anyone. Encrypting them would break SQL-based report aggregation. Downgraded to accepted risk at current scale.

### [HIGH-002] Missing Key Rotation Capability

- **Location:** `konote/encryption.py:28-38`
- **Issue:** `_get_fernet()` initialises a single `Fernet` instance. No support for `MultiFernet` or multiple keys. Key rotation requires re-encrypting all data with downtime.
- **Impact:** Cannot rotate encryption keys without data loss risk. If a key is suspected compromised, there's no safe rotation path.
- **Fix:** Accept comma-separated keys in `FIELD_ENCRYPTION_KEY`. Use `cryptography.fernet.MultiFernet` — first key encrypts, all keys decrypt.
- **Test:** Encrypt data with Key A, set env to "Key B,Key A", verify old data decrypts and new data uses Key B.

### [MEDIUM-001] Decryption Error Indicator Leak

- **Location:** `konote/encryption.py:61`
- **Issue:** `decrypt_field()` returns the string `"[decryption error]"` on failure. This appears in the UI, confirming to an observer that the field is encrypted and that the key or data is corrupt.
- **Impact:** Information leak about internal system state. Not directly exploitable but poor practice.
- **Fix:** Return empty string `""` instead. The error is already logged (line 60).
- **Test:** Corrupt a BinaryField value in the database. View the record — UI should show blank, not the error marker.

---

## OWASP Top 10 Results (from Jules)

| Check | Status | Notes |
|-------|--------|-------|
| A01 Broken Access Control | PASS | ProgramAccessMiddleware enforces program-scoped isolation |
| A02 Cryptographic Failures | FAIL | See HIGH-001, HIGH-002 |
| A03 Injection | PASS | No raw SQL with user input found |
| A04 Insecure Design | PASS | Failure denies access (least privilege) |
| A05 Security Misconfiguration | PASS | ALLOWED_HOSTS, CSP, security headers configured |
| A06 Vulnerable Components | PASS | No known CVEs flagged |
| A07 Auth Failures | PASS | Generic error messages, session config correct |
| A08 Data Integrity | PASS | CSRF on all forms |

## RBAC Attack Scenarios (from Jules)

| Scenario | Status | Notes |
|----------|--------|-------|
| IDOR (cross-program client access) | PASS | ProgramAccessMiddleware blocks |
| Vertical escalation (front desk → staff) | PASS | Role decorators enforce |
| Admin bypass (no program roles) | PASS | Middleware handles |
| Executive bypass | PASS | Role restrictions enforced |
| HTMX abuse | PASS | Middleware applies to all request types |
| Cross-program note access | PASS | Blocked by middleware |

---

## Regression Tests Needed

| Component | Test Case |
|-----------|-----------|
| Encryption | Verify `PlanTarget` name/description encryption round-trip |
| Encryption | Verify `PlanTargetRevision` encryption round-trip |
| Encryption | Verify `MultiFernet` key rotation (decrypt with secondary key) |
| Reports | Verify CSV/PDF exports work with encrypted plan targets |
| UI | Verify plan detail pages render correctly with encrypted fields |

## Recommendations (from Jules)

1. Implement MultiFernet for key rotation support
2. Review the `is_sensitive` flag on `CustomFieldDefinition` — ensure defaults cover PII
3. Review username logging in `apps/auth_app/views.py` — if usernames contain real names, consider hashing in logs
4. Ensure `MetricValue` validation (min/max/unit) is robust since values remain plaintext

---

## Review Metadata

- **Framework:** `tasks/code-review-framework.md` Prompt A (Security)
- **Tool:** Jules (jules.google) — Gemini-powered code review agent
- **Repo:** github.com/gilliankerr/KoNote-Redux (public, main branch)
- **Previous review:** None (first external security review)
- **Next scheduled:** Quarterly or after changes to encryption/RBAC/auth code
